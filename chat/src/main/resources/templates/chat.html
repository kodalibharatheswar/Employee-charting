<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Chat - CRM Module</title>
    
    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <style>
        /* Modern CRM Style Palette */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #1e293b;
            --bg-light: #f8fafc;
            --bg-sidebar: #0f172a;
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --sent-msg: #3b82f6;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-light); height: 100vh; overflow: hidden; color: var(--text-main); }

        .chat-container { display: flex; height: 100vh; width: 100vw; }

        /* Sidebar Styling */
        .sidebar { width: 350px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid #1e293b; }
        .sidebar-header h3 { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 8px; }
        .user-info { display: flex; align-items: center; gap: 8px; font-size: 13px; opacity: 0.9; }
        .status-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px #10b981; }

        /* Navigation Tabs */
        .tabs { display: flex; background: #1e293b; padding: 4px; margin: 10px 15px; border-radius: 8px; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: none; color: #94a3b8; cursor: pointer; font-size: 12px; font-weight: 600; border-radius: 6px; transition: 0.2s; }
        .tab-btn.active { color: white; background: var(--primary); }

        /* Sidebar Lists */
        .chat-list { flex: 1; overflow-y: auto; padding-top: 10px; }
        .list-section-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .list-section-header span { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #475569; letter-spacing: 1px; }
        .btn-add { background: #334155; color: white; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-add:hover { background: var(--primary); }
        
        .chat-item { padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; transition: 0.2s; border-bottom: 1px solid #1e293b; }
        .chat-item:hover { background: #1e293b; }
        .chat-item.active { background: #1e293b; border-left-color: var(--primary); }
        .item-name { display: block; font-weight: 500; font-size: 14px; color: #f1f5f9; }
        .item-preview { display: block; font-size: 11px; color: #64748b; margin-top: 2px; }

        /* Main Chat Window */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #f1f5f9; }
        .welcome { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--text-muted); }
        .welcome h2 { font-size: 24px; color: var(--secondary); margin-bottom: 8px; }
        
        /* Chat Header with Action Buttons */
        .chat-header { padding: 16px 24px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-header-info { cursor: pointer; transition: opacity 0.2s; flex: 1; margin-right: 20px; }
        .chat-header-info:hover { opacity: 0.7; }
        .chat-header h4 { font-size: 16px; font-weight: 600; }

        /* Header Action Buttons (Right Side) */
        .header-actions { display: flex; align-items: center; gap: 8px; }
        
        /* Search Button */
        .btn-search {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: 0.2s;
        }
        .btn-search:hover {
            background: var(--bg-light);
            color: var(--primary);
        }
        .btn-search svg {
            width: 20px;
            height: 20px;
        }

        /* Phone/Call Menu Button */
        .btn-phone {
            background: none;
            border: 1px solid var(--primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            transition: 0.2s;
            position: relative;
        }
        .btn-phone:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }
        .btn-phone svg {
            width: 20px;
            height: 20px;
        }

        /* Three Dots More Menu Button */
        .btn-more {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: 0.2s;
        }
        .btn-more:hover {
            background: var(--bg-light);
            color: var(--text-main);
        }

        /* Dropdown Menu for Calls */
        .call-dropdown {
            position: absolute;
            top: 48px;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            min-width: 200px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        .call-dropdown.active {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .call-dropdown-item {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: none;
            background: white;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: var(--text-main);
            transition: 0.15s;
            border-bottom: 1px solid var(--bg-light);
        }
        .call-dropdown-item:last-child {
            border-bottom: none;
        }
        .call-dropdown-item:hover {
            background: var(--bg-light);
        }
        .call-dropdown-item svg {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }

        /* Search Bar */
        .search-bar {
            padding: 12px 24px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: none;
        }
        .search-bar.active {
            display: block;
        }
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            outline: none;
            font-size: 14px;
            transition: 0.2s;
        }
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 12px;
            color: var(--text-muted);
        }
        .search-icon svg {
            width: 18px;
            height: 18px;
        }
        .btn-close-search {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: 0.2s;
        }
        .btn-close-search:hover {
            background: var(--bg-light);
            color: var(--danger);
        }
        .btn-close-search svg {
            width: 16px;
            height: 16px;
        }
        .search-results {
            padding: 8px 24px;
            font-size: 12px;
            color: var(--text-muted);
            background: white;
            border-bottom: 1px solid var(--border);
            display: none;
        }
        .search-results.active {
            display: block;
        }
        
        .messages-container { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 12px; }

        /* Message Bubbles */
        .message { max-width: 65%; padding: 10px 14px; border-radius: 12px; font-size: 14px; position: relative; word-wrap: break-word; transition: background 0.3s; }
        .message.sent { align-self: flex-end; background: var(--sent-msg); color: white; border-bottom-right-radius: 2px; }
        .message.received { align-self: flex-start; background: white; color: var(--text-main); border-bottom-left-radius: 2px; border: 1px solid var(--border); }
        .message.highlight { background: #fef3c7; border: 2px solid #fbbf24; }
        .message .file-link { display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit; font-weight: 600; }
        .message.received .file-link { color: var(--primary); }

        /* Typing Indicator */
        .typing-wrapper {
            padding: 8px 24px;
            background: transparent;
            font-size: 13px;
            color: var(--text-muted);
            height: 32px;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .typing-wrapper.visible { opacity: 1; }
        
        .typing-dots { display: flex; gap: 3px; }
        .typing-dots span {
            width: 4px; height: 4px; background: #94a3b8; border-radius: 50%;
            animation: pulse 1.4s infinite ease-in-out;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Input Area */
        .input-area { padding: 20px; background: white; border-top: 1px solid var(--border); display: flex; gap: 12px; align-items: center; }
        input#message-input { flex: 1; padding: 12px 18px; border: 1px solid var(--border); border-radius: 24px; outline: none; background: var(--bg-light); transition: 0.2s; }
        input#message-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        
        .btn-upload { background: #f1f5f9; color: var(--text-muted); border: 1px solid var(--border); width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-upload:hover { background: #e2e8f0; color: var(--primary); }
        .btn-upload svg { width: 20px; height: 20px; }

        button#send-button { background: var(--primary); color: white; border: none; padding: 10px 24px; border-radius: 24px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button#send-button:hover { background: var(--primary-dark); transform: translateY(-1px); }

        /* Modal Styles */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 480px; border-radius: 16px; padding: 32px; position: relative; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .close-modal { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: var(--text-muted); transition: 0.2s; }
        .close-modal:hover { color: var(--secondary); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); text-transform: uppercase; }
        .form-group input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; outline: none; transition: 0.2s; }
        .form-group input:focus { border-color: var(--primary); }

        /* Checkbox List for Group Members */
        .checkbox-container { max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 4px; margin-top: 8px; background: var(--bg-light); }
        .user-select-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 6px; cursor: pointer; transition: 0.15s; }
        .user-select-item:hover { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .user-select-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
        .user-select-item div { font-size: 13px; font-weight: 500; }
        .user-select-item span { font-size: 11px; color: var(--text-muted); display: block; }

        /* Member Info List */
        .info-list { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; max-height: 250px; overflow-y: auto; }
        .info-user-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--bg-light); }

        .role-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .role-admin { background: #fee2e2; color: #ef4444; }
        .role-moderator { background: #fef3c7; color: #d97706; }
        .role-member { background: #dcfce7; color: #16a34a; }

        .btn-remove-member { background: none; border: none; color: var(--danger); font-size: 16px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: 0.2s; opacity: 0.6; }
        .btn-remove-member:hover { opacity: 1; background: #fee2e2; }

        .btn-submit { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: 0.2s; margin-top: 10px; }
        .btn-submit:disabled { background: var(--border); cursor: not-allowed; }

        .btn-outline { width: 100%; padding: 10px; background: white; border: 1px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; margin-top: 15px; transition: 0.2s; }
        .btn-outline:hover { background: var(--primary); color: white; }

        /* ==================================================================== */
        /* WEBRTC CALL STYLES */
        /* ==================================================================== */

        /* Incoming Call Modal */
        .call-modal-content { width: 400px; text-align: center; }
        .call-modal-content h3 { font-size: 20px; margin-bottom: 10px; color: var(--secondary); }
        .call-modal-content p { font-size: 16px; color: var(--text-muted); margin-bottom: 20px; }
        .call-modal-content .caller-avatar { width: 80px; height: 80px; background: var(--primary); border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; }
        
        .call-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn-accept { background: var(--success); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-accept:hover { background: #059669; transform: scale(1.05); }
        .btn-reject { background: var(--danger); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-reject:hover { background: #dc2626; transform: scale(1.05); }

        /* Active Call Modal */
        .active-call-content { width: 90vw; max-width: 1200px; height: 85vh; background: #0f172a; border-radius: 16px; padding: 0; overflow: hidden; position: relative; }
        
        #remote-video-container { width: 100%; height: calc(100% - 150px); background: #1e293b; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 10px; padding: 10px; position: relative; }
        #remote-video-container video { max-width: 100%; max-height: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        /* Audio only mode */
        #remote-video-container.audio-only { display: flex; align-items: center; justify-content: center; }
        #remote-video-container.audio-only::before { content: "üéµ"; font-size: 80px; color: rgba(255,255,255,0.3); }

        #local-video-container { position: absolute; top: 20px; right: 20px; width: 200px; height: 150px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5); background: #1e293b; z-index: 10; }
        #local-video-container video { width: 100%; height: 100%; object-fit: cover; }

        .call-info-bar { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.8); padding: 10px 20px; border-radius: 8px; color: white; backdrop-filter: blur(10px); z-index: 10; }
        #call-status { font-size: 14px; opacity: 0.8; }
        #call-duration { font-size: 18px; font-weight: 600; margin-left: 15px; }

        .call-controls-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 100px; background: linear-gradient(to top, rgba(15, 23, 42, 0.95), transparent); display: flex; align-items: center; justify-content: center; gap: 15px; padding: 20px; }
        
        .call-control-btn { width: 55px; height: 55px; border-radius: 50%; border: none; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .call-control-btn:hover { transform: scale(1.1); }
        .call-control-btn.muted { background: var(--danger); }
        .call-control-btn.camera-off { background: var(--danger); }

        #btn-mute { background: rgba(255,255,255,0.2); color: white; }
        #btn-camera { background: rgba(255,255,255,0.2); color: white; }
        #btn-toggle-screen-share { background: rgba(255,255,255,0.2); color: white; }
        #btn-end-call { background: var(--danger); color: white; width: 65px; height: 65px; font-size: 24px; }

        .hidden { display: none !important; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>CRM Messaging</h3>
                <div class="user-info">
                    <div class="status-dot"></div>
                    <span id="display-name" th:text="${currentUser.fullName}">Admin User</span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" id="tab-direct" onclick="switchTab('direct')">Direct</button>
                <button class="tab-btn" id="tab-groups" onclick="switchTab('groups')">Groups</button>
            </div>

            <div class="chat-list">
                <!-- Direct Messages Section -->
                <div id="direct-section">
                    <div class="list-section-header">
                        <span>Direct Messages</span>
                        <button class="btn-add" onclick="showModal('new-direct-modal')" title="New Conversation">+</button>
                    </div>
                    <div id="conversation-list"></div>
                </div>

                <!-- Groups Section -->
                <div id="groups-section" class="hidden">
                    <div class="list-section-header">
                        <span>Groups</span>
                        <button class="btn-add" onclick="showModal('new-group-modal')" title="Create New Group">+</button>
                    </div>
                    <div id="chatroom-list"></div>
                </div>
            </div>
        </div>

        <!-- Main Workspace -->
        <div class="main-chat">
            <div id="welcome-screen" class="welcome">
                <h2>Internal CRM Chat</h2>
                <p>Select a teammate or group to start collaborating</p>
            </div>

            <div id="chat-window" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <div class="chat-header">
                    <div class="chat-header-info" onclick="showGroupInfoIfApplicable()">
                        <h4 id="chat-title">Recipient Name</h4>
                        <span id="chat-subtitle" style="font-size: 11px; color: var(--text-muted); display: block; max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Syncing...</span>
                    </div>

                    <!-- Header Actions (Search + Phone + More) -->
                    <div class="header-actions">
                        <!-- Search Button -->
                        <button id="btn-search" class="btn-search" onclick="toggleSearch()" title="Search Messages">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>

                        <!-- Phone Call Button with Dropdown -->
                        <div style="position: relative;">
                            <button id="btn-phone" class="btn-phone" onclick="toggleCallMenu()" title="Make a Call">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                            
                            <!-- Call Dropdown Menu -->
                            <div id="call-dropdown" class="call-dropdown">
                                <button class="call-dropdown-item" onclick="handleCallClick('audio')">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    <span>Audio Call</span>
                                </button>
                                <button class="call-dropdown-item" onclick="handleCallClick('video')">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    <span>Video Call</span>
                                </button>
                                <button class="call-dropdown-item" onclick="handleCallClick('screen')">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    <span>Screen Share</span>
                                </button>
                            </div>
                        </div>

                        <!-- Three Dots Menu (for future options) -->
                        <button class="btn-more" onclick="toggleMoreMenu()" title="More Options">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <circle cx="12" cy="5" r="2"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                                <circle cx="12" cy="19" r="2"></circle>
                            </svg>
                        </button>

                        <!-- Close Button -->
                        <button onclick="closeChat()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 20px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Search Bar -->
                <div id="search-bar" class="search-bar">
                    <div class="search-input-wrapper">
                        <span class="search-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </span>
                        <input type="text" id="search-input" class="search-input" placeholder="Search messages..." oninput="searchMessages(this.value)">
                        <button class="btn-close-search" onclick="closeSearch()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Search Results Info -->
                <div id="search-results" class="search-results">
                    <span id="search-results-text"></span>
                </div>

                <div class="messages-container" id="messages-container"></div>

                <!-- Typing Indicator -->
                <div id="typing-indicator" class="typing-wrapper">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span id="typing-text"></span>
                </div>

                <div class="input-area">
                    <input type="file" id="file-input" class="hidden" onchange="handleFileUpload(this)">
                    <button class="btn-upload" onclick="document.getElementById('file-input').click()" title="Upload File">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                        </svg>
                    </button>
                    
                    <input type="text" id="message-input" placeholder="Write a message..." autocomplete="off">
                    <button id="send-button">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: New Direct Conversation -->
    <div id="new-direct-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">√ó</span>
            <h3 style="margin-bottom: 20px;">New Conversation</h3>
            <input type="text" id="search-users" placeholder="Search by employee name..." style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px;">
            <div id="users-list-modal" style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px;"></div>
        </div>
    </div>

    <!-- Modal: Create New Group -->
    <div id="new-group-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">√ó</span>
            <h3 style="margin-bottom: 20px;">Create Team Group</h3>
            <div class="form-group">
                <label>Group Name</label>
                <input type="text" id="group-name-input" placeholder="e.g. Sales Q1 Targets">
            </div>
            <div class="form-group">
                <label>Add Teammates</label>
                <input type="text" id="group-search-members" placeholder="Search employees..." style="margin-bottom: 10px; font-size: 12px;">
                <div id="members-checkbox-list" class="checkbox-container"></div>
            </div>
            <button class="btn-submit" id="btn-create-group" onclick="createGroup()">Create Group</button>
        </div>
    </div>

    <!-- Modal: Group Info -->
    <div id="group-info-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">√ó</span>
            <h3 id="info-modal-title">Group Details</h3>
            
            <div id="group-admin-tools" class="hidden" style="margin-top: 15px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                <label style="font-size: 11px; font-weight: bold; color: var(--text-muted); display: block; margin-bottom: 5px;">RENAME GROUP</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="edit-group-name" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
                    <button class="btn-submit" style="width: auto; padding: 8px 15px; margin: 0;" onclick="renameGroup()">Save</button>
                </div>
            </div>

            <div class="info-list" id="info-members-list"></div>
            <button class="btn-outline" id="btn-add-more-trigger" onclick="showAddMemberToGroupModal()">+ Add New Members</button>
        </div>
    </div>

    <!-- Modal: Add Members to Group -->
    <div id="add-member-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">√ó</span>
            <h3>Add New Teammates</h3>
            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">Select colleagues who aren't in this group yet.</p>
            
            <div class="form-group">
                <input type="text" id="add-member-search" placeholder="Search employees..." style="margin-bottom: 10px;">
                <div id="add-member-checkbox-list" class="checkbox-container"></div>
            </div>
            <button class="btn-submit" id="btn-save-new-members" onclick="addNewMembersToGroup()">Add to Group</button>
        </div>
    </div>

    <!-- Modal: Incoming Call -->
    <div id="incoming-call-modal" class="modal">
        <div class="modal-content call-modal-content">
            <div class="caller-avatar">üìû</div>
            <h3>Incoming <span id="call-type">Video Call</span></h3>
            <p><strong><span id="caller-name">John Doe</span></strong> is calling you...</p>
            
            <div class="call-actions">
                <button id="btn-accept-call" class="btn-accept">
                    <span>‚úÖ</span>
                    <span>Accept</span>
                </button>
                <button id="btn-reject-call" class="btn-reject">
                    <span>‚ùå</span>
                    <span>Decline</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Active Call -->
    <div id="active-call-modal" class="modal">
        <div class="modal-content active-call-content">
            <!-- Call Info -->
            <div class="call-info-bar">
                <span id="call-status">Connected</span>
                <span id="call-duration">00:00</span>
            </div>

            <!-- Local Video (Picture-in-Picture) -->
            <div id="local-video-container"></div>

            <!-- Remote Video Container -->
            <div id="remote-video-container"></div>

            <!-- Call Controls -->
            <div class="call-controls-bar">
                <button id="btn-mute" class="call-control-btn" title="Mute/Unmute">
                    üé§
                </button>
                <button id="btn-camera" class="call-control-btn" title="Camera On/Off">
                    üìπ
                </button>
                <button id="btn-toggle-screen-share" class="call-control-btn" title="Share Screen">
                    üñ•Ô∏è
                </button>
                <button id="btn-end-call" class="call-control-btn" title="End Call">
                    ‚úï
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Context -->
    <input type="hidden" id="currentUserId" th:value="${currentUser.id}">
    <input type="hidden" id="currentUsername" th:value="${currentUser.username}">

    <!-- Load WebRTC Scripts -->
    <script src="/js/webrtc.js"></script>
    <script src="/js/call-ui.js"></script>

    <script>
        // Global variables
        let stompClient = null;
        let webrtcManager = null;
        let callUIManager = null;
        let currentId = null;
        let currentType = null;
        let currentConversationId = null;
        let currentGroupAdminId = null;
        let isCreatingConversation = false;
        let conversationCreationTimeout = null;
        let currentGroupMembers = [];
        let subscriptions = [];
        let typingTimeout = null;
        let allMessages = []; // Store all messages for search
        const myId = document.getElementById('currentUserId').value;

        /**
         * Initialization
         */
        document.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
            loadConversations();
            loadChatRooms();
            
            document.getElementById('send-button').onclick = sendMessage;
            document.getElementById('message-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
            document.getElementById('message-input').addEventListener('input', sendTypingStatus);
            document.getElementById('search-users').oninput = (e) => searchUsers(e.target.value);
            document.getElementById('group-search-members').oninput = (e) => filterList('members-checkbox-list', e.target.value);
            document.getElementById('add-member-search').oninput = (e) => filterList('add-member-checkbox-list', e.target.value);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('call-dropdown');
                const phoneBtn = document.getElementById('btn-phone');
                if (dropdown && !dropdown.contains(e.target) && !phoneBtn.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        });

        /**
         * WebSocket & WebRTC Initialization
         */
        function initWebSocket() {
            stompClient = Stomp.over(new SockJS('/ws'));
            stompClient.debug = null;
            
            stompClient.connect({}, () => {
                console.log("WebSocket Connected");
                
                // Initialize WebRTC Manager
                webrtcManager = new WebRTCManager();
                webrtcManager.initialize(stompClient);
                
                // Initialize Call UI Manager
                callUIManager = new CallUIManager();
                callUIManager.initialize(webrtcManager);
                
                // Make callUIManager globally accessible
                window.callUIManager = callUIManager;
                
                console.log("WebRTC and Call UI initialized");
            });
        }

        /**
         * Call Menu Functions
         */
        function toggleCallMenu() {
            const dropdown = document.getElementById('call-dropdown');
            dropdown.classList.toggle('active');
        }

        function toggleMoreMenu() {
            // Future feature - can add more options here
            alert('More options coming soon!');
        }

        function handleCallClick(type) {
            // Close dropdown
            document.getElementById('call-dropdown').classList.remove('active');
            
            // Trigger call based on type
            if (callUIManager) {
                if (type === 'audio') {
                    callUIManager.initiateCall('AUDIO');
                } else if (type === 'video') {
                    callUIManager.initiateCall('VIDEO');
                } else if (type === 'screen') {
                    callUIManager.initiateCall('SCREEN_SHARE');
                }
            }
        }

        /**
         * Search Functions
         */
        function toggleSearch() {
            const searchBar = document.getElementById('search-bar');
            const searchInput = document.getElementById('search-input');
            
            if (searchBar.classList.contains('active')) {
                closeSearch();
            } else {
                searchBar.classList.add('active');
                searchInput.focus();
            }
        }

        function closeSearch() {
            const searchBar = document.getElementById('search-bar');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            
            searchBar.classList.remove('active');
            searchResults.classList.remove('active');
            searchInput.value = '';
            
            // Remove all highlights
            clearHighlights();
        }

        function searchMessages(query) {
            const searchResults = document.getElementById('search-results');
            const searchResultsText = document.getElementById('search-results-text');
            
            if (!query || query.trim() === '') {
                searchResults.classList.remove('active');
                clearHighlights();
                return;
            }
            
            // Search through messages
            const messages = document.querySelectorAll('.message');
            let matchCount = 0;
            let firstMatch = null;
            
            clearHighlights();
            
            messages.forEach(msg => {
                const text = msg.textContent.toLowerCase();
                if (text.includes(query.toLowerCase())) {
                    msg.classList.add('highlight');
                    matchCount++;
                    if (!firstMatch) firstMatch = msg;
                }
            });
            
            // Show results
            if (matchCount > 0) {
                searchResults.classList.add('active');
                searchResultsText.textContent = `Found ${matchCount} message${matchCount > 1 ? 's' : ''}`;
                
                // Scroll to first match
                if (firstMatch) {
                    firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                searchResults.classList.add('active');
                searchResultsText.textContent = 'No messages found';
            }
        }

        function clearHighlights() {
            document.querySelectorAll('.message.highlight').forEach(msg => {
                msg.classList.remove('highlight');
            });
        }

        /**
         * Helper Functions
         */
        function getApiUrl(path) {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') return path;
            const base = window.location.origin.startsWith('blob:') ? '' : window.location.origin;
            return base.replace(/\/$/, "") + "/" + path.replace(/^\//, "");
        }

        async function fetchJson(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (response.redirected && response.url.includes('/login')) {
                    window.location.reload();
                    return;
                }
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const ct = response.headers.get("content-type");
                return (ct && ct.includes("application/json")) ? await response.json() : null;
            } catch (err) {
                console.error("API Call Failed:", url, err);
                throw err;
            }
        }

        /**
         * Typing Indicator
         */
        function sendTypingStatus() {
            if (!stompClient || !currentId) return;
            stompClient.send("/app/chat.typing", {}, JSON.stringify({
                chatType: currentType === 'direct' ? 'conversation' : 'chatroom',
                chatId: currentId,
                isTyping: true
            }));
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                stompClient.send("/app/chat.typing", {}, JSON.stringify({
                    chatType: currentType === 'direct' ? 'conversation' : 'chatroom',
                    chatId: currentId,
                    isTyping: false
                }));
            }, 1500);
        }

        function handleTypingNotification(data) {
            if (String(data.userId) === String(myId)) return;
            const wrapper = document.getElementById('typing-indicator');
            const textEl = document.getElementById('typing-text');
            if (data.isTyping) {
                textEl.innerText = `${data.fullName} is typing...`;
                wrapper.classList.add('visible');
            } else {
                wrapper.classList.remove('visible');
            }
        }

        /**
         * Navigation
         */
        function switchTab(type) {
            document.getElementById('tab-direct').classList.toggle('active', type === 'direct');
            document.getElementById('tab-groups').classList.toggle('active', type === 'groups');
            document.getElementById('direct-section').classList.toggle('hidden', type !== 'direct');
            document.getElementById('groups-section').classList.toggle('hidden', type !== 'groups');
        }

        /**
         * Data Loading
         */
        async function loadConversations() {
            try {
                const users = await fetchJson(getApiUrl('/api/users'));
                if (!users) return;
                const html = users.map(u => `
                    <div class="chat-item" id="item-direct-${u.id}" onclick="startDirectChat('${u.id}', '${u.fullName}')">
                        <span class="item-name">${u.fullName}</span>
                        <span class="item-preview">${u.department || 'Employee'}</span>
                    </div>
                `).join('');
                document.getElementById('conversation-list').innerHTML = html;
                highlightActive();
            } catch (e) { }
        }

        async function loadChatRooms() {
            try {
                const rooms = await fetchJson(getApiUrl('/api/chatrooms'));
                if (!rooms) return;
                const html = rooms.map(r => `
                    <div class="chat-item" id="item-group-${r.id}" onclick="openChat('${r.id}', '${r.name}', 'group', ${r.createdById})">
                        <span class="item-name"># ${r.name}</span>
                        <span class="item-preview">${r.memberCount} active members</span>
                    </div>
                `).join('');
                document.getElementById('chatroom-list').innerHTML = html;
                highlightActive();
            } catch (e) { }
        }

        async function loadMembersForGroup() {
            try {
                const users = await fetchJson(getApiUrl('/api/users'));
                const html = users.filter(u => u.id != myId).map(u => `
                    <label class="user-select-item" data-name="${u.fullName.toLowerCase()}">
                        <input type="checkbox" name="group-members" value="${u.id}">
                        <div><div>${u.fullName}</div><span>${u.department || 'N/A'}</span></div>
                    </label>
                `).join('');
                document.getElementById('members-checkbox-list').innerHTML = html;
            } catch (e) { }
        }

        /**
         * Search
         */
        async function searchUsers(query) {
            if(!query) { document.getElementById('users-list-modal').innerHTML = ''; return; }
            try {
                const users = await fetchJson(getApiUrl(`/api/users/search?query=${encodeURIComponent(query)}`));
                const html = users.map(u => `
                    <div class="user-select-item" style="background: var(--bg-light); margin: 2px 0;" onclick="startDirectChat('${u.id}', '${u.fullName}')">
                        <div style="font-weight: 600;">${u.fullName}</div>
                    </div>
                `).join('');
                document.getElementById('users-list-modal').innerHTML = html;
            } catch (e) { }
        }

        function filterList(containerId, query) {
            const val = query.toLowerCase();
            document.querySelectorAll(`#${containerId} .user-select-item`).forEach(item => {
                const name = item.dataset.name || item.innerText.toLowerCase();
                item.style.display = name.includes(val) ? 'flex' : 'none';
            });
        }

        /**
         * File Upload
         */
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file || !currentId) return;
            const formData = new FormData();
            formData.append("file", file);
            formData.append("chatId", currentId);
            formData.append("chatType", currentType);
            try {
                const messageData = await fetchJson(getApiUrl('/api/chat/upload'), {
                    method: 'POST',
                    body: formData
                });
                displayMessage(messageData);
                input.value = "";
            } catch (err) {
                alert("File upload failed.");
            }
        }

        /**
         * Chat Functions
         */
        async function startDirectChat(userId, name) {
            if (isCreatingConversation) {
                console.log('Already creating conversation, please wait...');
                return;
            }
            if (conversationCreationTimeout) clearTimeout(conversationCreationTimeout);
            isCreatingConversation = true;
            try {
                const res = await fetchJson(getApiUrl('/api/conversations?recipientId=' + userId), { method: 'POST' });
                closeModals();
                switchTab('direct');
                currentConversationId = res.conversationId;
                openChat(res.conversationId, name, 'direct');
                await loadConversations();
            } catch (e) {
                console.error('Error starting chat:', e);
                alert("Could not start chat. Please try again.");
            } finally {
                conversationCreationTimeout = setTimeout(() => {
                    isCreatingConversation = false;
                }, 1000);
            }
        }

        async function createGroup() {
            const name = document.getElementById('group-name-input').value.trim();
            if(!name) return;
            try {
                const room = await fetchJson(getApiUrl('/api/chatrooms'), {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: name, type: 'GROUP' })
                });
                const selectedMembers = Array.from(document.querySelectorAll('input[name="group-members"]:checked')).map(cb => cb.value);
                for (const uid of selectedMembers) {
                    await fetchJson(getApiUrl(`/api/chatrooms/${room.id}/members`), {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ userId: uid, role: 'MEMBER' })
                    });
                }
                closeModals(); 
                switchTab('groups'); 
                await loadChatRooms();
                openChat(room.id, room.name, 'group', myId);
            } catch (e) { alert("Error creating group."); }
        }

        async function openChat(id, title, type, creatorId) {
            currentId = id; 
            currentType = type;
            currentGroupAdminId = creatorId || null;
            
            if (type === 'direct') {
                currentConversationId = id;
            }
            
            // Close search if open
            closeSearch();
            
            document.getElementById('typing-indicator').classList.remove('visible');
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('chat-title').innerText = title;
            document.getElementById('chat-subtitle').innerText = 'Syncing...';
            document.getElementById('messages-container').innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-muted);">Loading...</p>';
            highlightActive();
            
            try {
                const msgUrl = type === 'direct' ? getApiUrl(`/api/conversations/${id}/messages`) : getApiUrl(`/api/chatrooms/${id}/messages`);
                const msgs = await fetchJson(msgUrl);
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                // Store messages for search
                allMessages = msgs || [];
                
                if(msgs && msgs.length > 0) msgs.forEach(displayMessage);
                if (type === 'group') {
                    await refreshGroupMembersDisplay();
                    if (webrtcManager) {
                        webrtcManager.subscribeToGroupCall(id);
                    }
                } else {
                    document.getElementById('chat-subtitle').innerText = 'Active now';
                }
                subscriptions.forEach(s => s.unsubscribe());
                subscriptions = [];
                const dest = type === 'direct' ? `conversation.${id}` : `chatroom.${id}`;
                subscriptions.push(stompClient.subscribe(`/topic/${dest}`, (m) => {
                    const data = JSON.parse(m.body);
                    if (data.type === 'ROLE_UPDATE') {
                        refreshGroupMembersDisplay();
                        showNotification(data.message || `${data.userName} role updated to ${data.newRole}`);
                    } else {
                        displayMessage(data);
                        allMessages.push(data);
                        document.getElementById('typing-indicator').classList.remove('visible');
                    }
                }));
                subscriptions.push(stompClient.subscribe(`/topic/${dest}.typing`, (m) => handleTypingNotification(JSON.parse(m.body))));
            } catch (e) { document.getElementById('chat-subtitle').innerText = 'Offline'; }
        }

        async function refreshGroupMembersDisplay() {
            const memberUrl = getApiUrl(`/api/chatrooms/${currentId}/members`);
            const members = await fetchJson(memberUrl);
            if (members) {
                currentGroupMembers = members;
                document.getElementById('chat-subtitle').innerText = members.map(m => m.fullName).join(", ");
            }
        }

        function showGroupInfoIfApplicable() {
            if(currentType !== 'group') return;
            fetch(`/api/chatrooms/${currentId}/members`)
                .then(response => response.json())
                .then(members => {
                    currentGroupMembers = members;
                    document.getElementById('info-modal-title').innerText = document.getElementById('chat-title').innerText;
                    const myRecord = currentGroupMembers.find(m => String(m.id) === String(myId));
                    const isAdmin = myRecord && myRecord.role === 'ADMIN';
                    document.getElementById('group-admin-tools').classList.toggle('hidden', !isAdmin);
                    if (isAdmin) document.getElementById('edit-group-name').value = document.getElementById('chat-title').innerText;
                    const addMemberBtn = document.getElementById('btn-add-more-trigger');
                    if (addMemberBtn) addMemberBtn.style.display = isAdmin ? 'block' : 'none';
                    const list = document.getElementById('info-members-list');
                    list.innerHTML = `<p style="font-weight:bold; font-size:12px; margin-bottom:10px; color:var(--text-muted)">MEMBERS LIST</p>` + 
                    currentGroupMembers.map(m => {
                        const role = m.role || 'MEMBER';
                        const isSelf = String(m.id) === String(myId);
                        return `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #f1f5f9">
                            <div>
                                <div style="font-weight:500; font-size:14px">${m.fullName} ${isSelf ? '<span style="font-size:11px; opacity:0.6">(You)</span>' : ''}</div>
                                <span class="role-badge role-${role.toLowerCase()}">${role}</span>
                            </div>
                            ${!isSelf && isAdmin ? `<button class="btn-remove-member" onclick="removeMember(${m.id}, '${m.fullName}')">‚úï</button>` : ''}
                        </div>
                        `;
                    }).join('');
                    showModal('group-info-modal');
                });
        }

        async function renameGroup() {
            const newName = document.getElementById('edit-group-name').value.trim();
            if (!newName) return alert("Enter a group name");
            try {
                await fetchJson(getApiUrl(`/api/chatrooms/${currentId}/name`), {
                    method: 'PUT', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: newName })
                });
                document.getElementById('chat-title').innerText = newName;
                await loadChatRooms();
                closeModals();
            } catch (e) { alert("Error renaming group."); }
        }

        async function removeMemberFromGroup(userId, fullName) {
            if (!confirm(`Are you sure you want to remove ${fullName} from the group?`)) return;
            try {
                const response = await fetch(getApiUrl(`/api/chatrooms/${currentId}/members/${userId}`), { method: 'DELETE' });
                if (response.ok) {
                    await refreshGroupMembersDisplay();
                    await loadChatRooms();
                    showGroupInfoIfApplicable();
                }
            } catch (e) { alert("Error removing member"); }
        }

        async function removeMember(userId, fullName) {
            const myRecord = currentGroupMembers.find(m => String(m.id) === String(myId));
            const isAdmin = myRecord && myRecord.role === 'ADMIN';
            if (!isAdmin) {
                alert('Only admins can remove members from the group.');
                return;
            }
            await removeMemberFromGroup(userId, fullName);
        }

        async function showAddMemberToGroupModal() {
            const myRecord = currentGroupMembers.find(m => String(m.id) === String(myId));
            const isAdmin = myRecord && myRecord.role === 'ADMIN';
            if (!isAdmin) {
                alert('Only admins can add new members to the group.');
                return;
            }
            document.getElementById('group-info-modal').classList.remove('active');
            document.getElementById('add-member-modal').classList.add('active');
            try {
                const users = await fetchJson(getApiUrl('/api/users'));
                const existingMemberIds = currentGroupMembers.map(m => m.id);
                const container = document.getElementById('add-member-checkbox-list');
                const addableUsers = users.filter(u => !existingMemberIds.includes(u.id));
                container.innerHTML = addableUsers.length ? addableUsers.map(u => `
                    <label class="user-select-item" data-name="${u.fullName.toLowerCase()}">
                        <input type="checkbox" name="new-group-members" value="${u.id}">
                        <div><div>${u.fullName}</div><span>${u.department || 'N/A'}</span></div>
                    </label>
                `).join('') : '<p style="font-size:12px; padding:10px; color:var(--text-muted);">Everyone is already in the group.</p>';
            } catch (e) { }
        }

        async function addNewMembersToGroup() {
            const btn = document.getElementById('btn-save-new-members');
            const selectedIds = Array.from(document.querySelectorAll('input[name="new-group-members"]:checked')).map(cb => cb.value);
            if (!selectedIds.length) return alert("Select members");
            btn.disabled = true; btn.innerText = "Adding...";
            try {
                for (const uid of selectedIds) {
                    await fetchJson(getApiUrl(`/api/chatrooms/${currentId}/members`), {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ userId: uid, role: 'MEMBER' })
                    });
                }
                closeModals();
                await refreshGroupMembersDisplay();
                await loadChatRooms();
                showGroupInfoIfApplicable();
            } catch (e) { alert("Error adding members"); }
            finally { btn.disabled = false; btn.innerText = "Add to Group"; }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const val = input.value.trim();
            if(!val || !currentId) return;
            const payload = { content: val, type: 'TEXT' };
            if(currentType === 'direct') payload.conversationId = currentId; 
            else payload.chatRoomId = currentId;
            stompClient.send(currentType === 'direct' ? '/app/chat.sendDirectMessage' : '/app/chat.sendGroupMessage', {}, JSON.stringify(payload));
            input.value = '';
        }

        function displayMessage(msg) {
            const container = document.getElementById('messages-container');
            const isMe = String(msg.senderId) === String(myId);
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            div.dataset.messageId = msg.id || '';
            let contentHtml = '';
            if (msg.type === 'FILE' || msg.type === 'IMAGE') {
                contentHtml = `<a href="${msg.content}" target="_blank" class="file-link"><span>üìÑ</span> <span>${msg.content.split('_').pop() || 'Download'}</span></a>`;
            } else {
                if(!isMe && currentType === 'group') contentHtml += `<span style="font-size:9px; font-weight:bold; display:block; margin-bottom:4px; opacity:0.8;">${msg.senderName}</span>`;
                contentHtml += `<span>${msg.content}</span>`;
            }
            div.innerHTML = contentHtml;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        /**
         * UI Utilities
         */
        function highlightActive() {
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            const el = document.getElementById((currentType === 'direct' ? 'item-direct-' : 'item-group-') + currentId);
            if(el) el.classList.add('active');
        }

        function showModal(id) {
            document.getElementById(id).classList.add('active');
            if(id === 'new-group-modal') loadMembersForGroup();
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            document.getElementById('group-name-input').value = '';
            document.getElementById('search-users').value = '';
            document.getElementById('add-member-search').value = '';
        }

        function closeChat() {
            document.getElementById('chat-window').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
            currentId = null;
            currentConversationId = null;
            closeSearch();
            highlightActive();
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'var(--danger)' : 'var(--primary)';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>