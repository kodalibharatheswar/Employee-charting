<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Chat - CRM Module</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #1e293b;
            --bg-light: #f8fafc;
            --bg-sidebar: #0f172a;
            --bg-secondary-sidebar: #1e293b;
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --sent-msg: #3b82f6;
            --received-msg: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --status-available: #10b981;
            --status-away: #f59e0b;
            --status-busy: #ef4444;
            --status-invisible: #94a3b8;
            --status-dnd: #dc2626;
            --icon-nav-width: 65px;
            --content-sidebar-width: 320px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            height: 100vh;
            overflow: hidden;
            color: var(--text-main);
        }

        .chat-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Icon Navigation Sidebar */
        .icon-nav {
            width: var(--icon-nav-width);
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-logo {
            width: 45px;
            height: 45px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 24px;
            font-weight: bold;
        }

        .nav-icons {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
            padding: 0 8px;
        }

        .nav-icon {
            width: 49px;
            height: 49px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: none;
            color: #94a3b8;
            position: relative;
        }

        .nav-icon:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }

        .nav-icon.active {
            background: var(--primary);
            color: white;
        }

        .nav-icon svg {
            width: 24px;
            height: 24px;
        }

        .nav-icon-label {
            font-size: 9px;
            margin-top: 2px;
            font-weight: 500;
        }

        .nav-bottom {
            margin-top: auto;
            padding: 8px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            position: relative;
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background: var(--success);
            border: 2px solid var(--bg-sidebar);
            border-radius: 50%;
        }

        /* Status color variants for user avatar */
        .user-avatar.status-available::after {
            background: var(--status-available);
        }

        .user-avatar.status-away::after {
            background: var(--status-away);
        }

        .user-avatar.status-busy::after {
            background: var(--status-busy);
        }

        .user-avatar.status-invisible::after {
            background: var(--status-invisible);
        }

        .user-avatar.status-dnd::after {
            background: var(--status-dnd);
        }

        .user-avatar.status-invisible::after {
            display: none;
        }

        /* Content Sidebar */
        .content-sidebar {
            width: var(--content-sidebar-width);
            background: var(--bg-secondary-sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }

        .content-sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .content-sidebar-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        /* Status Dropdown */
        .status-dropdown-container {
            position: relative;
        }

        .status-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 13px;
        }

        .status-selector:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.available {
            background: var(--status-available);
        }

        .status-dot.away {
            background: var(--status-away);
        }

        .status-dot.busy {
            background: var(--status-busy);
        }

        .status-dot.invisible {
            background: var(--status-invisible);
        }

        .status-dot.dnd {
            background: var(--status-dnd);
        }

        .status-text {
            flex: 1;
            color: #94a3b8;
        }

        .status-dropdown-arrow {
            color: #64748b;
            font-size: 16px;
        }

        /* Status Dropdown Menu */
        .status-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .status-dropdown-menu.active {
            display: block;
        }

        .status-section-label {
            padding: 12px 16px 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .status-menu-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: none;
            background: white;
            width: 100%;
            text-align: left;
            transition: 0.15s;
            color: var(--text-main);
        }

        .status-menu-item:hover {
            background: var(--bg-light);
        }

        .status-menu-item.selected {
            background: #dbeafe;
        }

        .status-menu-item .status-dot {
            width: 12px;
            height: 12px;
        }

        .status-menu-item-text {
            flex: 1;
            font-size: 14px;
        }

        .status-menu-item-check {
            color: var(--primary);
            font-size: 16px;
        }

        /* My Pins Section */
        .my-pins-section {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 250px;
            overflow-y: auto;
        }

        .my-pins-section.has-pins {
            padding: 16px 0;
        }

        .my-pins-section.empty {
            display: none;
        }

        .my-pins-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px 12px;
        }

        .my-pins-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }

        .pins-menu-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        .pin-item {
            padding: 10px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            background: rgba(255, 255, 255, 0.03);
            margin: 2px 0;
        }

        .pin-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .pin-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: var(--primary);
        }

        .pin-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            position: relative;
        }

        .pin-content {
            flex: 1;
            min-width: 0;
        }

        .pin-name {
            font-weight: 500;
            font-size: 13px;
            color: #f1f5f9;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pin-indicator-icon {
            color: #10b981;
            font-size: 10px;
            margin-right: 4px;
        }

        .btn-unpin {
            opacity: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f87171;
            transition: 0.2s;
        }

        .pin-item:hover .btn-unpin {
            opacity: 1;
        }

        .btn-unpin:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Conversations Section */
        .conversations-section {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 16px 20px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .conversations-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }

        .btn-add-conversation {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .btn-add-conversation:hover {
            background: var(--primary);
        }

        .sidebar-search {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-search-input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
        }

        .sidebar-search-input::placeholder {
            color: #64748b;
        }

        .sidebar-search-input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary);
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .conversation-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .conversation-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: var(--primary);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--status-available);
            border: 2px solid var(--bg-secondary-sidebar);
            border-radius: 50%;
        }

        .online-indicator.available {
            background: var(--status-available) !important;
        }

        .online-indicator.away {
            background: var(--status-away) !important;
        }

        .online-indicator.busy {
            background: var(--status-busy) !important;
        }

        .online-indicator.invisible {
            display: none;
        }

        .online-indicator.dnd {
            background: var(--status-dnd) !important;
        }

        .chat-header-avatar .online-indicator {
            border: 2px solid white;
        }

        .conversation-content {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 500;
            font-size: 14px;
            color: #f1f5f9;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-status {
            font-size: 12px;
            color: #64748b;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Conversation Actions */
        .conversation-actions {
            display: none;
            align-items: center;
            gap: 4px;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .conversation-item:hover .conversation-actions {
            display: flex;
        }

        .btn-conv-action {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            transition: 0.2s;
        }

        .btn-conv-action:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-conv-action svg {
            width: 16px;
            height: 16px;
        }

        /* More Menu Dropdown */
        .more-menu {
            position: absolute;
            right: 12px;
            top: 100%;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            display: none;
            margin-top: 4px;
        }

        .more-menu.active {
            display: block;
        }

        .more-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: none;
            background: white;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: var(--text-main);
            transition: 0.15s;
            border-bottom: 1px solid var(--bg-light);
        }

        .more-menu-item:last-child {
            border-bottom: none;
        }

        .more-menu-item:hover {
            background: var(--bg-light);
        }

        .more-menu-item.danger {
            color: var(--danger);
        }

        .more-menu-item svg {
            width: 18px;
            height: 18px;
        }

        /* Main Chat Window */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f1f5f9;
        }

        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-muted);
        }

        .welcome h2 {
            font-size: 24px;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        /* Chat Header */
        .chat-header {
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: white;
            position: relative;
        }

        .chat-header-avatar .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            border: 2px solid white;
            border-radius: 50%;
        }

        .chat-header-info {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chat-header-info:hover {
            opacity: 0.7;
        }

        .chat-header-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 2px;
        }

        .chat-header-status {
            font-size: 12px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chat-header-status.away {
            color: var(--status-away);
        }

        .chat-header-status.busy {
            color: var(--status-busy);
        }

        .chat-header-status.invisible {
            color: var(--status-invisible);
        }

        .chat-header-status.dnd {
            color: var(--status-dnd);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-header-action {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: 0.2s;
        }

        .btn-header-action:hover {
            background: var(--bg-light);
            color: var(--primary);
        }

        .btn-header-action svg {
            width: 20px;
            height: 20px;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-toast.hiding {
            animation: slideOut 0.3s ease;
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @keyframes highlight {

            0%,
            100% {
                background: rgba(255, 255, 255, 0.03);
            }

            50% {
                background: rgba(59, 130, 246, 0.15);
            }
        }

        .has-unread {
            background: rgba(59, 130, 246, 0.08) !important;
        }

        .unread-badge {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-sender {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 13px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #94a3b8;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            color: #64748b;
        }

        /* Message status ticks */
        .msg-status {
            display: inline-block;
            margin-left: 4px;
            font-size: 14px;
            line-height: 1;
        }

        .msg-status.sent {
            color: #94a3b8;
        }

        .msg-status.delivered {
            color: #94a3b8;
        }

        .msg-status.read {
            color: #3b82f6;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Date Separator */
        .date-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 16px 0;
        }

        .date-separator-line {
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .date-separator-text {
            padding: 0 16px;
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Message Group */
        .message-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message-group.sent {
            align-items: flex-end;
        }

        .message-group.received {
            align-items: flex-start;
        }

        /* Message Sender Info */
        .message-sender {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-sender-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            color: white;
        }

        .message-sender-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary);
        }

        /* Message Bubble */
        .message-bubble {
            max-width: 500px;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }

        .message-group.sent .message-bubble {
            background: var(--sent-msg);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-group.received .message-bubble {
            background: white;
            color: var(--text-main);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        /* File Attachment */
        .file-attachment {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            max-width: 400px;
        }

        .file-attachment:hover {
            background: var(--bg-light);
        }

        .file-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--secondary);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Typing Indicator */
        .typing-wrapper {
            padding: 8px 24px;
            background: transparent;
            font-size: 13px;
            color: var(--text-muted);
            height: 32px;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .typing-wrapper.visible {
            opacity: 1;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            background: #94a3b8;
            border-radius: 50%;
            animation: pulse 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: white;
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 8px 16px;
            transition: 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-actions-left {
            display: flex;
            gap: 4px;
        }

        .btn-input-action {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: 0.2s;
        }

        .btn-input-action:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--primary);
        }

        .btn-input-action svg {
            width: 20px;
            height: 20px;
        }

        input#message-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
            color: var(--text-main);
        }

        input#message-input::placeholder {
            color: var(--text-muted);
        }

        button#send-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }

        button#send-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 480px;
            border-radius: 16px;
            padding: 32px;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-muted);
            transition: 0.2s;
        }

        .close-modal:hover {
            color: var(--secondary);
        }

        /* User Info Modal */
        .user-info-content {
            text-align: center;
        }

        .user-info-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            font-weight: 600;
            margin: 0 auto 20px;
        }

        .user-info-name {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .user-info-email {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .user-info-details {
            text-align: left;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .user-info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-light);
        }

        .user-info-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 13px;
        }

        .user-info-value {
            color: var(--secondary);
            font-size: 13px;
        }

        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        .conversation-list::-webkit-scrollbar,
        .messages-container::-webkit-scrollbar,
        .my-pins-section::-webkit-scrollbar,
        .status-dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .conversation-list::-webkit-scrollbar-track,
        .my-pins-section::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .messages-container::-webkit-scrollbar-track,
        .status-dropdown-menu::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversation-list::-webkit-scrollbar-thumb,
        .messages-container::-webkit-scrollbar-thumb,
        .my-pins-section::-webkit-scrollbar-thumb,
        .status-dropdown-menu::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }




        /* Sidebar Section Toggle */
        .sidebar-section {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .sidebar-section.hidden {
            display: none !important;
        }

        /* Group Items */
        .group-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .group-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .group-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: var(--primary);
        }

        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }

        .group-content {
            flex: 1;
            min-width: 0;
        }

        .group-name {
            font-weight: 500;
            font-size: 14px;
            color: #f1f5f9;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .group-info {
            font-size: 12px;
            color: #64748b;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .group-admin-badge {
            background: #3b82f6;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: 600;
        }

        /* Group Chat Header */
        .group-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: white;
        }

        /* Group Settings Modal */
        .group-settings-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .group-settings-section:last-child {
            border-bottom: none;
        }

        .group-settings-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .group-member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--bg-light);
        }

        .group-member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .group-member-info {
            flex: 1;
        }

        .group-member-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--secondary);
        }

        .group-member-role {
            font-size: 12px;
            color: var(--text-muted);
        }

        .btn-change-role {
            background: var(--bg-light);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-main);
            transition: 0.2s;
        }

        .btn-change-role:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-remove-member {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
        }

        .btn-remove-member:hover {
            background: var(--danger);
            color: white;
        }

        .group-name-edit-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .group-name-edit-input:focus {
            border-color: var(--primary);
        }

        .btn-save-group-name {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            width: 100%;
        }

        .btn-save-group-name:hover {
            background: var(--primary-dark);
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <!-- Icon Navigation (Left Sidebar) -->
        <div class="icon-nav">
            <div class="app-logo">C</div>

            <div class="nav-icons">
                <button class="nav-icon active" id="nav-chats" onclick="switchSection('chats')" title="Chats">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                        </path>
                    </svg>
                    <span class="nav-icon-label">Chats</span>
                </button>

                <button class="nav-icon" id="nav-groups" onclick="switchSection('groups')" title="Groups">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                        </path>
                    </svg>
                    <span class="nav-icon-label">Groups</span>
                </button>

                <button class="nav-icon" id="nav-calls" onclick="switchSection('calls')" title="Calls">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                        </path>
                    </svg>
                    <span class="nav-icon-label">Calls</span>
                </button>

                <button class="nav-icon" id="nav-files" onclick="switchSection('files')" title="Files">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                    </svg>
                    <span class="nav-icon-label">Files</span>
                </button>

                <button class="nav-icon" id="nav-calendar" onclick="switchSection('calendar')" title="Calendar">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span class="nav-icon-label">Calendar</span>
                </button>

                <button class="nav-icon" id="nav-notes" onclick="switchSection('notes')" title="Notes">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                        </path>
                    </svg>
                    <span class="nav-icon-label">Notes</span>
                </button>
            </div>

            <div class="nav-bottom">
                <div class="user-avatar status-available" id="user-avatar-btn" title="Profile">
                    <span th:text="${currentUser.fullName.substring(0,1).toUpperCase()}">N</span>
                </div>
            </div>
        </div>

        <!-- Content Sidebar (Middle) -->
        <div class="content-sidebar">
            <div class="content-sidebar-header">
                <div class="content-sidebar-title">Direct Messages</div>

                <!-- Status Dropdown -->
                <div class="status-dropdown-container">
                    <div class="status-selector" id="status-selector" onclick="toggleStatusDropdown()">
                        <div class="status-dot available" id="current-status-dot"></div>
                        <span class="status-text" id="current-status-text">Available</span>
                        <span class="status-dropdown-arrow">▼</span>
                    </div>

                    <div class="status-dropdown-menu" id="status-dropdown-menu">
                        <div class="status-section-label">Default Status</div>

                        <button class="status-menu-item selected" data-status="AVAILABLE"
                            onclick="changeStatus('AVAILABLE', 'Available')">
                            <div class="status-dot available"></div>
                            <span class="status-menu-item-text">Available</span>
                            <span class="status-menu-item-check">✓</span>
                        </button>

                        <button class="status-menu-item" data-status="AWAY" onclick="changeStatus('AWAY', 'Away')">
                            <div class="status-dot away"></div>
                            <span class="status-menu-item-text">Away</span>
                            <span class="status-menu-item-check"></span>
                        </button>

                        <button class="status-menu-item" data-status="BUSY" onclick="changeStatus('BUSY', 'Busy')">
                            <div class="status-dot busy"></div>
                            <span class="status-menu-item-text">Busy</span>
                            <span class="status-menu-item-check"></span>
                        </button>

                        <button class="status-menu-item" data-status="INVISIBLE"
                            onclick="changeStatus('INVISIBLE', 'Invisible')">
                            <div class="status-dot invisible"></div>
                            <span class="status-menu-item-text">Invisible</span>
                            <span class="status-menu-item-check"></span>
                        </button>

                        <button class="status-menu-item" data-status="DND"
                            onclick="changeStatus('DND', 'Do not disturb')">
                            <div class="status-dot dnd"></div>
                            <span class="status-menu-item-text">Do not disturb</span>
                            <span class="status-menu-item-check"></span>
                        </button>

                        <div class="status-section-label">Custom Status</div>

                        <button class="status-menu-item" data-status="ENGAGED"
                            onclick="changeStatus('ENGAGED', 'Engaged at work')">
                            <div class="status-dot busy"></div>
                            <span class="status-menu-item-text">Engaged at work</span>
                            <span class="status-menu-item-check"></span>
                        </button>

                        <button class="status-menu-item" data-status="AVAILABLE_COLLAB"
                            onclick="changeStatus('AVAILABLE_COLLAB', 'Available for Collaboration')">
                            <div class="status-dot available"></div>
                            <span class="status-menu-item-text">Available for Collaboration</span>
                            <span class="status-menu-item-check"></span>
                        </button>

                        <button class="status-menu-item" data-status="IN_MEETING"
                            onclick="changeStatus('IN_MEETING', 'In a Meeting')">
                            <div class="status-dot dnd"></div>
                            <span class="status-menu-item-text">In a Meeting</span>
                            <span class="status-menu-item-check"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- MY PINS Section -->
            <div class="my-pins-section empty" id="my-pins-section">
                <div class="my-pins-header">
                    <span class="my-pins-title">MY PINS</span>
                    <button class="pins-menu-btn">⋯</button>
                </div>
                <div id="pins-list"></div>
            </div>

            <!-- Conversations Section -->
            <div class="conversations-section">
                <div class="conversations-header">
                    <span class="conversations-title">CONVERSATIONS</span>
                    <button class="btn-add-conversation" onclick="showModal('new-direct-modal')"
                        title="New Conversation">+</button>
                </div>

                <div class="sidebar-search">
                    <input type="text" class="sidebar-search-input" id="sidebar-search-input" placeholder="Search..."
                        oninput="filterConversations(this.value)">
                </div>

                <div class="conversation-list" id="conversation-list"></div>
            </div>
        </div>

        <!-- GROUPS SECTION (Hidden by default) -->
        <div id="groups-section" class="sidebar-section hidden">
            <div class="content-sidebar-header">
                <div class="content-sidebar-title">Groups</div>
            </div>

            <!-- Groups Search -->
            <div class="sidebar-search">
                <input type="text" class="sidebar-search-input" id="groups-search-input" placeholder="Search groups..."
                    oninput="filterGroups(this.value)">
            </div>

            <!-- Groups Section -->
            <div class="conversations-section">
                <div class="conversations-header">
                    <span class="conversations-title">MY GROUPS</span>
                    <button class="btn-add-conversation" onclick="showModal('create-group-modal')"
                        title="Create Group">+</button>
                </div>

                <div class="conversation-list" id="groups-list"></div>
            </div>
        </div>
    </div>

    <!-- Main Chat Window (Right) -->
    <div class="main-chat">
        <div id="welcome-screen" class="welcome">
            <h2>Internal CRM Chat</h2>
            <p>Select a teammate or group to start collaborating</p>
        </div>

        <div id="chat-window" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
            <div class="chat-header">
                <div class="chat-header-left" id="header-info-container">
                    <div class="chat-header-avatar">
                        <span id="chat-avatar-initial">U</span>
                        <div class="online-indicator" id="chat-header-indicator"></div>
                    </div>
                    <div class="chat-header-info" onclick="showChatInfo()">
                        <div class="chat-header-name" id="chat-header-name">User Name</div>
                        <div class="chat-header-status" id="chat-header-status-container">
                            <span id="chat-header-status">Available</span>
                        </div>
                    </div>
                </div>


                <!-- NEW: Search Input Container (Hidden by default) -->
                <div id="search-container" class="hidden"
                    style="flex: 1; margin: 0 15px; display: flex; align-items: center;">
                    <input type="text" id="chat-message-search" placeholder="Search messages..."
                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 20px; outline: none;"
                        oninput="performMessageSearch(this.value)">
                </div>

                <div class="header-actions">
                    <button class="btn-header-action" id="search-toggle-btn" onclick="toggleSearch()" title="Search">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>


                    <!-- Replace the call button in the .header-actions div with this -->
                    <div class="call-dropdown-container" style="position: relative;">
                        <button class="btn-header-action" onclick="toggleCallMenu(event)" title="Start Call">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                </path>
                            </svg>
                        </button>

                        <div id="call-menu" class="more-menu" style="right: 0; top: 110%; width: 180px;">
                            <button class="more-menu-item" onclick="initiateSpecificCall('AUDIO')">
                                <span style="margin-right: 10px;">📞</span> Audio Call
                            </button>
                            <button class="more-menu-item" onclick="initiateSpecificCall('VIDEO')">
                                <span style="margin-right: 10px;">📹</span> Video Call
                            </button>
                            <button class="more-menu-item" onclick="initiateSpecificCall('SCREEN_SHARE')">
                                <span style="margin-right: 10px;">🖥️</span> Share Screen
                            </button>
                        </div>
                    </div>

                    <!--  INCOMING CALL MODAL -->
                    <div id="incoming-call-modal" class="modal">
                        <div class="modal-content" style="width: 400px; text-align: center;">
                            <div style="margin-bottom: 20px;">
                                <div class="user-info-avatar-large"
                                    style="margin: 0 auto 15px; width: 80px; height: 80px;">
                                    <span id="incoming-caller-avatar">C</span>
                                </div>
                                <h3 id="caller-name" style="margin: 0 0 5px 0;">Incoming Call</h3>
                                <p id="call-type" style="color: var(--text-muted); margin: 0;">Audio Call</p>
                            </div>

                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button id="btn-reject-call"
                                    style="background: #ef4444; color: white; border: none; padding: 15px 30px; border-radius: 50px; cursor: pointer; font-weight: 600;">
                                    ✕ Decline
                                </button>
                                <button id="btn-accept-call"
                                    style="background: #10b981; color: white; border: none; padding: 15px 30px; border-radius: 50px; cursor: pointer; font-weight: 600;">
                                    ✓ Accept
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ACTIVE CALL MODAL -->
                    <div id="active-call-modal" class="modal">
                        <div class="modal-content"
                            style="width: 90%; max-width: 1200px; height: 80vh; padding: 0; overflow: hidden;">
                            <!-- Call Header -->
                            <div
                                style="background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div id="call-status" style="font-size: 14px; color: #94a3b8;">Connecting...
                                    </div>
                                    <div id="call-duration" style="font-size: 18px; font-weight: 600;">00:00</div>
                                </div>
                                <button onclick="if(window.callUIManager) window.callUIManager.endCall()"
                                    style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600;">
                                    End Call
                                </button>
                            </div>

                            <!-- Video Container -->
                            <div
                                style="position: relative; flex: 1; background: #0f172a; display: flex; align-items: center; justify-content: center; height: calc(80vh - 130px);">
                                <!-- Remote Video -->
                                <div id="remote-video-container"
                                    style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #1e293b;">
                                    <div style="color: #64748b; font-size: 18px;">Waiting for other participant...
                                    </div>
                                </div>

                                <!-- Local Video (Picture-in-Picture) -->
                                <div id="local-video-container"
                                    style="position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; background: #334155; border-radius: 10px; overflow: hidden; border: 2px solid white;">
                                </div>
                            </div>

                            <!-- Call Controls -->
                            <div
                                style="background: #1e293b; padding: 20px; display: flex; justify-content: center; gap: 15px;">
                                <button id="btn-mute"
                                    style="background: rgba(255,255,255,0.1); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    🎤
                                </button>
                                <button id="btn-camera"
                                    style="background: rgba(255,255,255,0.1); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    📹
                                </button>
                                <button id="btn-toggle-screen-share"
                                    style="background: rgba(255,255,255,0.1); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    🖥️
                                </button>
                                <button id="btn-end-call"
                                    onclick="if(window.callUIManager) window.callUIManager.endCall()"
                                    style="background: #ef4444; color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    📞
                                </button>
                            </div>
                        </div>
                    </div>

                    <button class="btn-header-action" onclick="closeChat()" title="Close">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messages-container"></div>

            <div id="typing-indicator" class="typing-wrapper">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
                <span id="typing-text"></span>
            </div>

            <div class="input-area">
                <input type="file" id="file-input" class="hidden" onchange="handleFileUpload(this)">
                <div class="input-wrapper">
                    <div class="input-actions-left">
                        <button class="btn-input-action" onclick="document.getElementById('file-input').click()"
                            title="Attach File">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                </path>
                            </svg>
                        </button>
                    </div>

                    <input type="text" id="message-input" placeholder="Message..." autocomplete="off">

                    <div class="input-actions-right">
                        <button id="send-button" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- New Conversation Modal -->
    <div id="new-direct-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">×</span>
            <h3 style="margin-bottom: 20px;">New Conversation</h3>
            <input type="text" id="search-users" placeholder="Search by name..."
                style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px;"
                oninput="searchUsers(this.value)">
            <div id="users-list-modal" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- User Info Modal -->
    <div id="user-info-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">×</span>
            <div class="user-info-content">
                <div class="user-info-avatar-large" id="info-avatar">U</div>
                <div class="user-info-name" id="info-name">User Name</div>
                <div class="user-info-email" id="info-email">user@example.com</div>
                <div class="user-info-details">
                    <div class="user-info-row">
                        <span class="user-info-label">Department</span>
                        <span class="user-info-value" id="info-department">N/A</span>
                    </div>
                    <div class="user-info-row">
                        <span class="user-info-label">Status</span>
                        <span class="user-info-value" id="info-status">Online</span>
                    </div>
                    <div class="user-info-row">
                        <span class="user-info-label">Username</span>
                        <span class="user-info-value" id="info-username">username</span>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Create Group Modal -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">×</span>
            <h3 style="margin-bottom: 20px;">Create New Group</h3>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Group Name</label>
                <input type="text" id="group-name-input" placeholder="Enter group name..."
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Description (Optional)</label>
                <textarea id="group-description-input" placeholder="Enter group description..."
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; min-height: 80px; resize: vertical;"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600;">Add Members</label>
                <input type="text" id="search-members-input" placeholder="Search users..."
                    style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;"
                    oninput="searchMembersForGroup(this.value)">
                <div id="members-selection-list"
                    style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
                </div>
            </div>

            <button onclick="createGroup()"
                style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Create Group
            </button>
        </div>
    </div>

    <!-- Group Settings Modal -->
    <div id="group-settings-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="closeModals()">×</span>
            <h3 style="margin-bottom: 24px;">Group Settings</h3>

            <!-- Group Name Section -->
            <div class="group-settings-section">
                <div class="group-settings-label">Group Name</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="edit-group-name-input" class="group-name-edit-input" readonly
                        style="flex: 1;">
                    <button id="btn-edit-group-name" onclick="enableGroupNameEdit()"
                        style="background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; white-space: nowrap;">
                        Edit
                    </button>
                </div>
                <button id="btn-save-group-name" onclick="saveGroupName()" class="btn-save-group-name hidden">
                    Save Changes
                </button>
            </div>

            <!-- Members Section -->
            <div class="group-settings-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div class="group-settings-label" style="margin: 0;">Members</div>
                    <button onclick="showAddMembersModal()"
                        style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        + Add Members
                    </button>
                </div>
                <div id="group-members-list"></div>
            </div>

            <!-- Leave/Delete Group -->
            <div class="group-settings-section">
                <button id="btn-leave-group" onclick="leaveGroup()"
                    style="width: 100%; padding: 12px; background: var(--warning); color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                    Leave Group
                </button>
                <button id="btn-delete-group" onclick="deleteGroup()" class="hidden"
                    style="width: 100%; padding: 12px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Delete Group
                </button>
            </div>
        </div>
    </div>

    <!-- Add Members to Group Modal -->
    <div id="add-members-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModals()">×</span>
            <h3 style="margin-bottom: 20px;">Add Members</h3>

            <input type="text" id="search-add-members-input" placeholder="Search users..."
                style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px;"
                oninput="searchUsersToAdd(this.value)">

            <div id="add-members-list" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>


    <input type="hidden" id="currentUserId" th:value="${currentUser.id}">
    <input type="hidden" id="currentUsername" th:value="${currentUser.username}">

    <script src="/js/webrtc.js"></script>
    <script src="/js/call-ui.js"></script>

    <script>
        let stompClient = null;
        let currentId = null;
        let currentType = 'direct';
        let currentConversationId = null;
        let allMessages = [];
        let subscriptions = [];
        let typingTimeout = null;
        let currentSection = 'chats';
        let currentRecipient = null;
        let allUsers = [];
        let pinnedUsers = new Set();
        let currentUserStatus = 'AVAILABLE';

        let messageTracker = new Map();
        let tempMessageId = 1;
        let pendingMessages = new Map();

        let isSearchActive = false;

        // ============================================
        // GROUPS FUNCTIONALITY
        // ============================================
        let currentGroupId = null;
        let currentGroupData = null;
        let selectedMembersForGroup = new Set();

        // Initialize WebRTC Manager after STOMP connection
        let webrtcManager;
        let callUIManager;

        // Store original initWebSocket function
        const originalInitWebSocket = initWebSocket;
        // Override initWebSocket to initialize WebRTC after connection
        initWebSocket = function () {
            originalInitWebSocket();

            // Wait for STOMP connection, then initialize WebRTC
            const checkConnection = setInterval(() => {
                if (stompClient && stompClient.connected) {
                    clearInterval(checkConnection);

                    // Initialize WebRTC Manager
                    webrtcManager = new WebRTCManager();
                    webrtcManager.initialize(stompClient);

                    // Initialize Call UI Manager
                    callUIManager = new CallUIManager();
                    callUIManager.initialize(webrtcManager);

                    // Make globally accessible
                    window.webrtcManager = webrtcManager;
                    window.callUIManager = callUIManager;

                    console.log('✅ WebRTC and Call UI Managers initialized');
                }
            }, 100);
        };

        const myId = document.getElementById('currentUserId').value;
        const myUsername = document.getElementById('currentUsername').value;

        const STATUS_MAP = {
            'AVAILABLE': { text: 'Available', dotClass: 'available', textClass: '' },
            'AWAY': { text: 'Away', dotClass: 'away', textClass: 'away' },
            'BUSY': { text: 'Busy', dotClass: 'busy', textClass: 'busy' },
            'INVISIBLE': { text: 'Invisible', dotClass: 'invisible', textClass: 'invisible' },
            'DND': { text: 'Do not disturb', dotClass: 'dnd', textClass: 'dnd' },
            'ENGAGED': { text: 'Engaged at work', dotClass: 'busy', textClass: 'busy' },
            'AVAILABLE_COLLAB': { text: 'Available for Collaboration', dotClass: 'available', textClass: '' },
            'IN_MEETING': { text: 'In a Meeting', dotClass: 'dnd', textClass: 'dnd' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
            loadPinnedUsers();
            loadCurrentUserStatus();
            loadConversations();

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.status-dropdown-container')) {
                    document.getElementById('status-dropdown-menu').classList.remove('active');
                }
                if (!e.target.closest('.conversation-item') && !e.target.closest('.pin-item')) {
                    document.querySelectorAll('.more-menu').forEach(menu => menu.remove());
                }
            });
        });

        function initWebSocket() {
            stompClient = Stomp.over(new SockJS('/ws'));
            stompClient.debug = null;

            stompClient.connect({}, () => {
                console.log("✅ WebSocket Connected");

                const userId = document.getElementById('currentUserId').value;
                console.log("👤 Current User ID:", userId);

                // Subscribe to user status updates
                stompClient.subscribe('/topic/user.status', (message) => {
                    const statusUpdate = JSON.parse(message.body);
                    handleStatusUpdate(statusUpdate);
                });

                // Subscribe to public notifications
                stompClient.subscribe('/topic/public', (message) => {
                    const data = JSON.parse(message.body);
                    if (data.type === 'USER_ONLINE') handleUserOnline(data);
                });

                // ✅ NEW: Subscribe to user-specific call notifications
                stompClient.subscribe('/user/' + userId + '/queue/call', (message) => {
                    console.log('📞 [chat.html] Received call notification:', message.body);
                    const data = JSON.parse(message.body);
                    if (data.type === 'INCOMING_CALL') {
                        console.log('🔔 Incoming call from:', data.callerName);
                    }
                });

                // Alternative subscription
                stompClient.subscribe('/user/queue/call', (message) => {
                    console.log('📞 [chat.html ALT] Received call notification:', message.body);
                });

                // Delivery acknowledgments
                stompClient.subscribe('/user/queue/delivery', (message) => {
                    const ack = JSON.parse(message.body);
                    handleDeliveryAcknowledgment(ack);
                });

                // Read receipts
                stompClient.subscribe('/user/queue/read-receipts', (message) => {
                    const receipt = JSON.parse(message.body);
                    handleReadReceipt(receipt);
                });

                // Message notifications
                stompClient.subscribe('/user/queue/notifications', (notification) => {
                    const data = JSON.parse(notification.body);
                    if (data.type === 'NEW_MESSAGE') {
                        showNotification(data.senderName, data.content, data.senderId);
                        if (data.conversationId) updateConversationListAfterMessage({
                            conversationId: data.conversationId,
                            senderId: data.senderId,
                            content: data.content,
                            createdAt: data.timestamp
                        });
                    }
                });

                // Add user online
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({ username: myUsername }));

                console.log("✅ All subscriptions registered for user:", userId);
            }, (error) => {
                console.error("❌ WebSocket connection error:", error);
                setTimeout(initWebSocket, 5000);
            });
        }


        function showNotification(senderName, message, senderId) {
            if (currentId && String(currentRecipient?.id) === String(senderId)) return;
            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            const initial = senderName.charAt(0).toUpperCase();
            notification.innerHTML = `
                <div class="notification-avatar">${initial}</div>
                <div class="notification-content">
                    <div class="notification-sender">${senderName}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function renderMessageStatus(message, isOwnMessage) {
            if (!isOwnMessage) return '';
            const status = message.deliveryStatus || 'SENT';
            if (status === 'READ') return '<span class="msg-status read">✓✓</span>';
            if (status === 'DELIVERED') return '<span class="msg-status delivered">✓✓</span>';
            return '<span class="msg-status sent">✓</span>';
        }


        // Replace the toggleSearch function and add performMessageSearch
        function toggleSearch() {
            const headerInfo = document.getElementById('header-info-container');
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('chat-message-search');
            const searchBtn = document.getElementById('search-toggle-btn');

            isSearchActive = !isSearchActive;

            if (isSearchActive) {
                headerInfo.classList.add('hidden');
                searchContainer.classList.remove('hidden');
                searchInput.focus();
                searchBtn.style.color = 'var(--primary)';
            } else {
                headerInfo.classList.remove('hidden');
                searchContainer.classList.add('hidden');
                searchInput.value = '';
                searchBtn.style.color = '';
                // Reset message view
                renderMessages(allMessages);
            }
        }


        // Add these functions to your script block
        function toggleCallMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('call-menu');
            const isVisible = menu.classList.contains('active');

            // Close other menus first
            document.querySelectorAll('.more-menu').forEach(m => m.classList.remove('active'));

            if (!isVisible) {
                menu.classList.add('active');
            }
        }


        function initiateSpecificCall(type) {
            // Close menu
            document.getElementById('call-menu').classList.remove('active');

            if (!currentId || !currentRecipient) {
                alert("Please select a user to call.");
                return;
            }

            console.log(`🔥 Initiating ${type} call to ${currentRecipient.fullName}`);

            // Check if managers are initialized
            if (!window.webrtcManager || !window.callUIManager) {
                console.error('❌ WebRTC managers not initialized yet');
                alert('Call system is initializing. Please try again in a moment.');
                return;
            }

            // Start the call through WebRTC manager
            window.webrtcManager.startCall(currentType, currentId, type);

            // Update UI to show calling state
            if (window.callUIManager) {
                window.callUIManager.showActiveCall();
                window.callUIManager.updateStatusText('Calling...');
            }
        }


        // Add this to your existing window.onclick to close the call menu when clicking outside
        const originalOnClick = window.onclick;
        window.onclick = (e) => {
            if (originalOnClick) originalOnClick(e);
            if (!e.target.closest('.call-dropdown-container')) {
                document.getElementById('call-menu')?.classList.remove('active');
            }
        };


        async function performMessageSearch(query) {
            if (!query || query.length < 2) {
                renderMessages(allMessages);
                return;
            }

            try {
                const results = await fetchJson(`/api/messages/search?chatType=${currentType}&chatId=${currentId}&query=${encodeURIComponent(query)}`);
                if (results) {
                    renderSearchResults(results, query);
                }
            } catch (e) {
                console.error('Search failed:', e);
            }
        }


        function renderSearchResults(results, query) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No messages found matching "' + query + '"</div>';
                return;
            }

            container.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--primary); font-size: 13px; font-weight: 600;">Found ' + results.length + ' matches</div>';

            results.forEach(msg => {
                const isSent = String(msg.senderId) === String(myId);
                const messageGroup = createMessageElementWithStatus(msg, isSent, true);

                // Highlight matching text
                const bubble = messageGroup.querySelector('.message-bubble');
                if (bubble) {
                    const regex = new RegExp(`(${query})`, 'gi');
                    bubble.innerHTML = bubble.innerHTML.replace(regex, '<mark style="background: yellow; color: black; padding: 0 2px; border-radius: 2px;">$1</mark>');
                }

                container.appendChild(messageGroup);
            });
        }

        function handleUserOnline(data) {
            const userEl = document.querySelector(`[data-user-id="${data.userId}"]`);
            if (userEl) {
                const indicator = userEl.querySelector('.online-indicator');
                if (indicator && data.status) {
                    indicator.className = `online-indicator ${STATUS_MAP[data.status]?.dotClass || 'available'}`;
                }
            }
            if (currentRecipient && currentRecipient.id == data.userId) updateChatHeaderStatus(data.status || 'AVAILABLE');
        }

        function loadCurrentUserStatus() {
            const saved = localStorage.getItem('userStatus_' + myId);
            if (saved) {
                currentUserStatus = saved;
                updateStatusUI(currentUserStatus);
            }
        }

        function toggleStatusDropdown() {
            document.getElementById('status-dropdown-menu').classList.toggle('active');
        }

        async function changeStatus(status, statusText) {
            try {
                const response = await fetch(`/api/users/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                if (response.ok) {
                    currentUserStatus = status;
                    localStorage.setItem('userStatus_' + myId, status);
                    updateStatusUI(status);
                    if (stompClient?.connected) {
                        stompClient.send("/app/user.status.update", {}, JSON.stringify({
                            userId: myId, status: status, statusText: statusText
                        }));
                    }
                }
            } catch (e) { console.error('Failed to change status:', e); }
            document.getElementById('status-dropdown-menu').classList.remove('active');
        }

        function updateStatusUI(status) {
            const statusInfo = STATUS_MAP[status] || STATUS_MAP['AVAILABLE'];
            const statusDot = document.getElementById('current-status-dot');
            const statusText = document.getElementById('current-status-text');
            statusDot.className = `status-dot ${statusInfo.dotClass}`;
            statusText.textContent = statusInfo.text;
            updateUserAvatarStatus(status);
            document.querySelectorAll('.status-menu-item').forEach(item => {
                const check = item.querySelector('.status-menu-item-check');
                if (item.dataset.status === status) {
                    item.classList.add('selected');
                    check.textContent = '✓';
                } else {
                    item.classList.remove('selected');
                    check.textContent = '';
                }
            });
        }

        function updateUserAvatarStatus(status) {
            const userAvatar = document.getElementById('user-avatar-btn');
            if (!userAvatar) return;
            userAvatar.classList.remove('status-available', 'status-away', 'status-busy', 'status-invisible', 'status-dnd');
            userAvatar.classList.add('status-' + (STATUS_MAP[status] || STATUS_MAP['AVAILABLE']).dotClass);
        }

        function handleStatusUpdate(statusUpdate) {
            const { userId, status, statusText } = statusUpdate;
            const convItem = document.getElementById(`conv-${userId}`);
            if (convItem) {
                const indicator = convItem.querySelector('.online-indicator');
                const statusInfo = STATUS_MAP[status] || STATUS_MAP['AVAILABLE'];
                if (indicator) indicator.className = `online-indicator ${statusInfo.dotClass}`;
                const statusEl = convItem.querySelector('.conversation-status');
                if (statusEl) statusEl.textContent = statusText || statusInfo.text;
            }
            if (currentRecipient && currentRecipient.id === String(userId)) updateChatHeaderStatus(status, statusText);
        }

        function updateChatHeaderStatus(status, statusText) {
            const statusInfo = STATUS_MAP[status] || STATUS_MAP['AVAILABLE'];
            const indicator = document.getElementById('chat-header-indicator');
            const statusContainer = document.getElementById('chat-header-status-container');
            const statusTextEl = document.getElementById('chat-header-status');
            if (indicator) indicator.className = `online-indicator ${statusInfo.dotClass}`;
            if (statusContainer) statusContainer.className = `chat-header-status ${statusInfo.textClass}`;
            if (statusTextEl) statusTextEl.textContent = statusText || statusInfo.text;
        }

        function loadPinnedUsers() {
            const saved = localStorage.getItem('pinnedUsers_' + myId);
            if (saved) pinnedUsers = new Set(JSON.parse(saved));
        }

        function savePinnedUsers() {
            localStorage.setItem('pinnedUsers_' + myId, JSON.stringify([...pinnedUsers]));
        }


        async function pinConversation(event, userId) {
            if (event) event.stopPropagation();
            console.log('📌 Attempting to pin user:', userId);

            try {
                const response = await fetch(`/api/conversations/pin/${userId}`, { method: 'POST' });
                console.log('📌 Pin response status:', response.status);

                const data = await response.json();
                console.log('📌 Pin response data:', data);

                if (response.ok) {
                    console.log('✅ Pin successful, adding to local set');
                    pinnedUsers.add(String(userId));

                    // Close menu
                    document.querySelectorAll('.more-menu').forEach(menu => menu.remove());

                    // Reload UI
                    console.log('🔄 Reloading conversations...');
                    await loadConversations();
                } else {
                    console.error('❌ Pin failed:', data);
                    alert('Failed to pin conversation: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                console.error('❌ Pin error:', e);
                alert('Failed to pin conversation: ' + e.message);
            }
        }


        async function unpinConversation(event, userId) {
            if (event) event.stopPropagation();
            console.log('📌 Attempting to unpin user:', userId);

            try {
                const response = await fetch(`/api/conversations/unpin/${userId}`, { method: 'POST' });
                console.log('📌 Unpin response status:', response.status);

                const data = await response.json();
                console.log('📌 Unpin response data:', data);

                if (response.ok) {
                    console.log('✅ Unpin successful, removing from local set');
                    pinnedUsers.delete(String(userId));
                    await loadConversations();
                } else {
                    console.error('❌ Unpin failed:', data);
                    alert('Failed to unpin conversation: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                console.error('❌ Unpin error:', e);
                alert('Failed to unpin conversation: ' + e.message);
            }
        }

        /**
 * Switch between Chats and Groups sections
 */
        function switchSection(section) {
            currentSection = section;

            // Update navigation icons
            document.querySelectorAll('.nav-icon').forEach(icon => icon.classList.remove('active'));
            document.getElementById(`nav-${section}`).classList.add('active');

            // Show/hide appropriate sidebar sections
            if (section === 'chats') {
                document.getElementById('chats-section').classList.remove('hidden');
                document.getElementById('groups-section').classList.add('hidden');
                loadConversations();
            } else if (section === 'groups') {
                document.getElementById('chats-section').classList.add('hidden');
                document.getElementById('groups-section').classList.remove('hidden');
                loadGroups();
            }
        }
        // function switchSection(section) {
        //     currentSection = section;
        //     document.querySelectorAll('.nav-icon').forEach(icon => icon.classList.remove('active'));
        //     document.getElementById(`nav-${section}`).classList.add('active');
        //     if (section === 'chats') loadConversations();
        // }

        /**
 * Load all groups for current user
 */
        async function loadGroups() {
            try {
                const groups = await fetchJson('/api/chatrooms');
                console.log('📦 Loaded groups:', groups.length);

                const groupsList = document.getElementById('groups-list');
                if (!groupsList) return;

                if (!groups || groups.length === 0) {
                    groupsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No groups yet. Create one to get started!</div>';
                    return;
                }

                groupsList.innerHTML = groups.map(group => {
                    const initial = group.name.charAt(0).toUpperCase();
                    const isCreator = group.createdById === parseInt(myId);

                    return `
                <div class="group-item" id="group-${group.id}" onclick="openGroup(${group.id}, '${group.name.replace(/'/g, "\\'")}', ${group.memberCount})">
                    <div class="group-avatar">${initial}</div>
                    <div class="group-content">
                        <div class="group-name">
                            ${group.name}
                            ${isCreator ? '<span class="group-admin-badge">Admin</span>' : ''}
                        </div>
                        <div class="group-info">${group.memberCount} members</div>
                    </div>
                </div>
            `;
                }).join('');

            } catch (error) {
                console.error('❌ Error loading groups:', error);
            }
        }

        /**
 * Filter groups by search query
 */
        function filterGroups(query) {
            document.querySelectorAll('.group-item').forEach(item => {
                const name = item.querySelector('.group-name').textContent.toLowerCase();
                item.style.display = name.includes(query.toLowerCase()) ? 'flex' : 'none';
            });
        }


        /**
 * Open a group chat
 */
        async function openGroup(groupId, groupName, memberCount) {
            try {
                currentId = groupId;
                currentType = 'group';
                currentGroupId = groupId;

                console.log('📦 Opening group:', groupName, 'ID:', groupId);

                // Hide welcome screen, show chat window
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('chat-window').classList.remove('hidden');

                // Update chat header for group
                document.getElementById('chat-avatar-initial').textContent = groupName.charAt(0).toUpperCase();
                document.getElementById('chat-header-name').textContent = groupName;

                const statusContainer = document.getElementById('chat-header-status-container');
                statusContainer.innerHTML = `<span>${memberCount} members</span>`;
                statusContainer.className = 'chat-header-status';

                // Load group messages
                const messages = await fetchJson(`/api/chatrooms/${groupId}/messages`);
                allMessages = messages || [];
                renderMessages(allMessages);

                // Subscribe to group messages
                subscribeToGroup(groupId);

                // Highlight active group
                document.querySelectorAll('.group-item').forEach(el => el.classList.remove('active'));
                const activeGroup = document.getElementById(`group-${groupId}`);
                if (activeGroup) activeGroup.classList.add('active');

                // Load group data for settings
                const groupData = await fetchJson(`/api/chatrooms/${groupId}`);
                currentGroupData = groupData;

            } catch (error) {
                console.error('❌ Error opening group:', error);
            }
        }

        /**
 * Subscribe to group WebSocket channel
 */
        function subscribeToGroup(groupId) {
            // Unsubscribe from previous channels
            subscriptions.forEach(s => s.unsubscribe());
            subscriptions = [];

            // Subscribe to group messages
            const sub = stompClient.subscribe(`/topic/chatroom.${groupId}`, (message) => {
                const msg = JSON.parse(message.body);
                displayNewMessage(msg);
            });
            subscriptions.push(sub);

            console.log('✅ Subscribed to group:', groupId);
        }

        /**
         * Search members for group creation
         */
        let allUsersForGroup = [];

        async function searchMembersForGroup(query) {
            if (!allUsersForGroup.length) {
                allUsersForGroup = await fetchJson('/api/users');
            }

            const filtered = allUsersForGroup.filter(u =>
                u.fullName.toLowerCase().includes(query.toLowerCase()) ||
                u.username.toLowerCase().includes(query.toLowerCase())
            );

            const list = document.getElementById('members-selection-list');
            list.innerHTML = filtered.map(u => `
        <div style="display: flex; align-items: center; gap: 12px; padding: 8px; cursor: pointer; border-radius: 6px; transition: 0.2s;" 
             onmouseover="this.style.background='var(--bg-light)'" 
             onmouseout="this.style.background='transparent'"
             onclick="toggleMemberSelection(${u.id}, '${u.fullName.replace(/'/g, "\\'")}', this)">
            <input type="checkbox" id="member-${u.id}" style="cursor: pointer;">
            <div class="notification-avatar">${u.fullName.charAt(0)}</div>
            <div style="flex: 1;">
                <div style="font-weight: 500;">${u.fullName}</div>
                <div style="font-size: 11px; color: var(--text-muted);">${u.department || 'N/A'}</div>
            </div>
        </div>
    `).join('');
        }

        /**
         * Toggle member selection for group creation
         */
        function toggleMemberSelection(userId, fullName, element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                selectedMembersForGroup.add(userId);
            } else {
                selectedMembersForGroup.delete(userId);
            }

            console.log('Selected members:', Array.from(selectedMembersForGroup));
        }

        /**
         * Create new group
         */
        async function createGroup() {
            const groupName = document.getElementById('group-name-input').value.trim();
            const groupDescription = document.getElementById('group-description-input').value.trim();

            if (!groupName) {
                alert('Please enter a group name');
                return;
            }

            try {
                // Create group
                const response = await fetch('/api/chatrooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: groupName,
                        description: groupDescription,
                        type: 'GROUP'
                    })
                });

                if (!response.ok) throw new Error('Failed to create group');

                const group = await response.json();
                console.log('✅ Group created:', group);

                // Add selected members
                if (selectedMembersForGroup.size > 0) {
                    await fetch(`/api/chatrooms/${group.id}/members/batch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(Array.from(selectedMembersForGroup))
                    });
                }

                // Reset form
                document.getElementById('group-name-input').value = '';
                document.getElementById('group-description-input').value = '';
                selectedMembersForGroup.clear();

                // Close modal and reload groups
                closeModals();
                loadGroups();

                // Auto-open the new group
                openGroup(group.id, group.name, selectedMembersForGroup.size + 1);

            } catch (error) {
                console.error('❌ Error creating group:', error);
                alert('Failed to create group. Please try again.');
            }
        }

        /**
         * Show group settings modal
         */
        async function showGroupSettings() {
            if (!currentGroupId || !currentGroupData) return;

            try {
                // Load current group data
                const group = await fetchJson(`/api/chatrooms/${currentGroupId}`);
                const members = await fetchJson(`/api/chatrooms/${currentGroupId}/members`);

                // Populate group name
                document.getElementById('edit-group-name-input').value = group.name;

                // Check if current user is admin
                const currentUserMember = members.find(m => m.id == myId);
                const isAdmin = currentUserMember && currentUserMember.role === 'ADMIN';

                // Show/hide admin controls
                document.getElementById('btn-edit-group-name').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('btn-delete-group').classList.toggle('hidden', !isAdmin);

                // Populate members list
                const membersList = document.getElementById('group-members-list');
                membersList.innerHTML = members.map(member => {
                    const initial = member.fullName.charAt(0).toUpperCase();
                    const isCurrentUser = member.id == myId;
                    const canChangeRole = isAdmin && !isCurrentUser;

                    return `
                <div class="group-member-item">
                    <div class="group-member-avatar">${initial}</div>
                    <div class="group-member-info">
                        <div class="group-member-name">
                            ${member.fullName} 
                            ${isCurrentUser ? '(You)' : ''}
                        </div>
                        <div class="group-member-role">${member.role}</div>
                    </div>
                    ${canChangeRole ? `
                        <button class="btn-change-role" onclick="toggleMemberRole(${member.id}, '${member.role}')">
                            ${member.role === 'ADMIN' ? 'Make Member' : 'Make Admin'}
                        </button>
                        <button class="btn-remove-member" onclick="removeMember(${member.id}, '${member.fullName.replace(/'/g, "\\'")}')">
                            Remove
                        </button>
                    ` : ''}
                </div>
            `;
                }).join('');

                showModal('group-settings-modal');

            } catch (error) {
                console.error('❌ Error loading group settings:', error);
            }
        }

        /**
         * Enable group name editing
         */
        function enableGroupNameEdit() {
            const input = document.getElementById('edit-group-name-input');
            const editBtn = document.getElementById('btn-edit-group-name');
            const saveBtn = document.getElementById('btn-save-group-name');

            input.readOnly = false;
            input.focus();
            editBtn.style.display = 'none';
            saveBtn.classList.remove('hidden');
        }

        /**
         * Save group name changes
         */
        async function saveGroupName() {
            const newName = document.getElementById('edit-group-name-input').value.trim();

            if (!newName) {
                alert('Group name cannot be empty');
                return;
            }

            try {
                await fetch(`/api/chatrooms/${currentGroupId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName, description: currentGroupData.description })
                });

                // Update UI
                document.getElementById('chat-header-name').textContent = newName;
                document.getElementById('edit-group-name-input').readOnly = true;
                document.getElementById('btn-edit-group-name').style.display = 'block';
                document.getElementById('btn-save-group-name').classList.add('hidden');

                // Reload groups list
                loadGroups();

                console.log('✅ Group name updated');

            } catch (error) {
                console.error('❌ Error updating group name:', error);
                alert('Failed to update group name');
            }
        }

        /**
         * Toggle member role between ADMIN and MEMBER
         */
        async function toggleMemberRole(userId, currentRole) {
            const newRole = currentRole === 'ADMIN' ? 'MEMBER' : 'ADMIN';

            try {
                await fetch(`/api/chatrooms/${currentGroupId}/members/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });

                console.log('✅ Member role updated');

                // Reload settings
                showGroupSettings();

            } catch (error) {
                console.error('❌ Error updating member role:', error);
                alert('Failed to update member role');
            }
        }

        /**
         * Remove member from group
         */
        async function removeMember(userId, memberName) {
            if (!confirm(`Remove ${memberName} from the group?`)) return;

            try {
                await fetch(`/api/chatrooms/${currentGroupId}/members/${userId}`, {
                    method: 'DELETE'
                });

                console.log('✅ Member removed');

                // Reload settings
                showGroupSettings();

            } catch (error) {
                console.error('❌ Error removing member:', error);
                alert('Failed to remove member');
            }
        }

        /**
         * Show add members modal
         */
        function showAddMembersModal() {
            closeModals();
            showModal('add-members-modal');
            searchUsersToAdd('');
        }

        /**
         * Search users to add to group
         */
        async function searchUsersToAdd(query) {
            try {
                const allUsers = await fetchJson('/api/users');
                const currentMembers = await fetchJson(`/api/chatrooms/${currentGroupId}/members`);
                const memberIds = new Set(currentMembers.map(m => m.id));

                const availableUsers = allUsers.filter(u => !memberIds.has(u.id));

                const filtered = availableUsers.filter(u =>
                    u.fullName.toLowerCase().includes(query.toLowerCase())
                );

                const list = document.getElementById('add-members-list');
                list.innerHTML = filtered.map(u => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg-light); margin: 4px 0; border-radius: 8px; cursor: pointer;"
                 onclick="addMemberToGroup(${u.id}, '${u.fullName.replace(/'/g, "\\'")}')">
                <div class="notification-avatar">${u.fullName.charAt(0)}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 500;">${u.fullName}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">${u.department || 'N/A'}</div>
                </div>
                <button style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;">
                    Add
                </button>
            </div>
        `).join('');

            } catch (error) {
                console.error('❌ Error searching users:', error);
            }
        }

        /**
         * Add member to group
         */
        async function addMemberToGroup(userId, userName) {
            try {
                await fetch(`/api/chatrooms/${currentGroupId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId })
                });

                console.log('✅ Member added:', userName);

                // Reload add members list
                searchUsersToAdd('');

                // Show success message
                alert(`${userName} added to the group!`);

            } catch (error) {
                console.error('❌ Error adding member:', error);
                alert('Failed to add member');
            }
        }

        /**
         * Leave group
         */
        async function leaveGroup() {
            if (!confirm('Are you sure you want to leave this group?')) return;

            try {
                await fetch(`/api/chatrooms/${currentGroupId}/members/${myId}`, {
                    method: 'DELETE'
                });

                console.log('✅ Left group');

                closeModals();
                closeChat();
                loadGroups();

            } catch (error) {
                console.error('❌ Error leaving group:', error);
                alert('Failed to leave group');
            }
        }

        /**
         * Delete group (admin only)
         */
        async function deleteGroup() {
            if (!confirm('Are you sure you want to delete this group? This cannot be undone.')) return;

            try {
                // Implementation depends on your backend
                alert('Delete group functionality - implement backend endpoint');

            } catch (error) {
                console.error('❌ Error deleting group:', error);
                alert('Failed to delete group');
            }
        }

        // Update chat header to show group settings icon
        function updateChatHeaderForGroup() {
            const headerActions = document.querySelector('.header-actions');

            // Add group settings button if in group chat
            if (currentType === 'group') {
                const settingsBtn = document.createElement('button');
                settingsBtn.className = 'btn-header-action';
                settingsBtn.onclick = showGroupSettings;
                settingsBtn.title = 'Group Settings';
                settingsBtn.innerHTML = `
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        `;

                // Insert before search button
                const searchBtn = document.getElementById('search-toggle-btn');
                headerActions.insertBefore(settingsBtn, searchBtn);
            }
        }



        async function loadConversations() {
            try {
                console.log('🔄 Loading conversations...');

                // 1. Fetch all users
                const users = await fetchJson('/api/users');
                console.log('✅ Fetched users:', users.length);

                // 2. Fetch pinned settings from database
                const pinnedData = await fetchJson('/api/conversations/pinned');
                console.log('📌 Pinned data response:', pinnedData);

                // 3. Clear and rebuild pinnedUsers Set
                pinnedUsers.clear();

                if (pinnedData && pinnedData.success && pinnedData.pinned) {
                    console.log('📌 Processing pinned conversations:', pinnedData.pinned.length);

                    pinnedData.pinned.forEach(settings => {
                        console.log('🔍 Settings object:', settings);

                        // ✅ FIX: Check both 'pinned' and 'isPinned' for compatibility
                        const isPinned = settings.pinned === true || settings.isPinned === true;

                        if (isPinned) {
                            pinnedUsers.add(String(settings.otherUserId));
                            console.log('✅ Added to pins:', settings.otherUserId);
                        }
                    });
                }

                console.log('📌 Total pinned users:', pinnedUsers.size, Array.from(pinnedUsers));

                // 4. Render UI
                const convList = document.getElementById('conversation-list');
                if (!convList) {
                    console.error('❌ conversation-list element not found!');
                    return;
                }
                convList.innerHTML = '';

                renderConversations(users);
                renderPinnedUsers(users);

                console.log(`✅ Rendered: ${pinnedUsers.size} pins, ${users.length - pinnedUsers.size} conversations`);

            } catch (error) {
                console.error('❌ Error loading conversations:', error);
            }
        }


        function renderPinnedUsers(users) {
            console.log('🎨 Rendering pinned users...');

            const pinsSection = document.getElementById('my-pins-section');
            const pinsList = document.getElementById('pins-list');

            if (!pinsSection || !pinsList) {
                console.error('❌ Pin section elements not found!');
                return;
            }

            const pinnedUsersList = users.filter(u => {
                const isPinned = pinnedUsers.has(String(u.id));
                if (isPinned) console.log('📌 Rendering pin for:', u.fullName);
                return isPinned;
            });

            console.log('📌 Pinned users to render:', pinnedUsersList.length);

            if (pinnedUsersList.length === 0) {
                console.log('ℹ️ No pinned users - hiding section');
                pinsSection.classList.add('empty');
                pinsSection.classList.remove('has-pins');
                pinsList.innerHTML = '';
                return;
            }

            // ✅ Show the pins section
            pinsSection.classList.remove('empty');
            pinsSection.classList.add('has-pins');

            pinsList.innerHTML = pinnedUsersList.map(u => {
                const initial = u.fullName.charAt(0).toUpperCase();
                const status = u.status || 'AVAILABLE';
                const statusInfo = STATUS_MAP[status] || STATUS_MAP['AVAILABLE'];

                const escapedName = u.fullName.replace(/'/g, "\\'");
                const escapedDept = (u.department || 'N/A').replace(/'/g, "\\'");
                const escapedEmail = (u.email || '').replace(/'/g, "\\'");
                const escapedUsername = (u.username || '').replace(/'/g, "\\'");

                return `
        <div class="pin-item" id="pin-${u.id}" 
             onclick="startDirectChat('${u.id}', '${escapedName}', '${escapedDept}', '${escapedEmail}', '${escapedUsername}', '${status}')">
            <div class="pin-avatar">
                ${initial}
                <div class="online-indicator ${statusInfo.dotClass}"></div>
            </div>
            <div class="pin-content">
                <div class="pin-name">📌 ${u.fullName}</div>
            </div>
            <button class="btn-unpin" onclick="unpinConversation(event, '${u.id}')" title="Unpin">✕</button>
        </div>`;
            }).join('');

            console.log('✅ Pinned section rendered successfully');
        }



        function renderConversations(users) {
            const unpinnedUsers = users.filter(u => !pinnedUsers.has(String(u.id)));
            const convList = document.getElementById('conversation-list');

            convList.innerHTML = unpinnedUsers.map(u => {
                const initial = u.fullName.charAt(0).toUpperCase();
                const statusInfo = STATUS_MAP[u.status] || STATUS_MAP['AVAILABLE'];
                const isPinned = pinnedUsers.has(String(u.id));
                const escapedName = u.fullName.replace(/'/g, "\\'");
                const escapedDept = (u.department || 'N/A').replace(/'/g, "\\'");
                const escapedEmail = (u.email || '').replace(/'/g, "\\'");
                const escapedUsername = (u.username || '').replace(/'/g, "\\'");
                const status = u.status || 'AVAILABLE';

                return `
                <div class="conversation-item" id="conv-${u.id}">
                    <!-- Avatar and content area triggers the chat -->
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;" 
                         onclick="startDirectChat('${u.id}', '${escapedName}', '${escapedDept}', '${escapedEmail}', '${escapedUsername}', '${status}')">
                        <div class="conversation-avatar">
                            ${initial}
                            <div class="online-indicator ${statusInfo.dotClass}"></div>
                        </div>
                        <div class="conversation-content">
                            <div class="conversation-name">${u.fullName}</div>
                            <div class="conversation-status">${statusInfo.text}</div>
                        </div>
                    </div>
                    
                    <div class="conversation-actions">
                        <button class="btn-conv-action" onclick="showMoreMenu(event, '${u.id}', ${isPinned})" title="More">
                            <svg fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="5" r="2"></circle><circle cx="12" cy="12" r="2"></circle><circle cx="12" cy="19" r="2"></circle></svg>
                        </button>
                        <button class="btn-conv-action" onclick="showUserInfo(event, '${u.id}', '${escapedName}', '${escapedEmail}', '${escapedDept}', '${escapedUsername}', '${status}')" title="Info">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                        <button class="btn-conv-action" onclick="removeConversation(event, '${u.id}', '${escapedName}')" title="Remove">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        async function showMoreMenu(event, userId, isPinned) {
            event.stopPropagation();
            document.querySelectorAll('.more-menu').forEach(menu => menu.remove());

            // Fetch current settings for this conversation
            const settings = await fetchJson(`/api/conversations/settings/${userId}`);
            const isMuted = settings && settings.isMuted;

            const convItem = document.getElementById(`conv-${userId}`) || document.getElementById(`pin-${userId}`);
            if (!convItem) return;

            const menu = document.createElement('div');
            menu.className = 'more-menu active';

            const pinText = isPinned ? 'Unpin conversation' : 'Pin conversation';
            const pinAction = isPinned ? `unpinConversation(event, '${userId}')` : `pinConversation(event, '${userId}')`;

            const muteText = isMuted ? 'Unmute' : 'Mute';
            const muteIcon = isMuted ? '🔊' : '🔇';

            menu.innerHTML = `
                <button class="more-menu-item" onclick="markAsUnreadLocally(event, '${userId}')">
                    <span style="margin-right: 8px;">✉️</span> Mark as unread
                </button>
                <button class="more-menu-item" onclick="toggleMute(event, '${userId}', ${isMuted})">
                    <span style="margin-right: 8px;">${muteIcon}</span> ${muteText}
                </button>
                <button class="more-menu-item" onclick="${pinAction}">
                    <span style="margin-right: 8px;">📌</span> ${pinText}
                </button>
                <button class="more-menu-item danger" onclick="removeConversation(event, '${userId}', 'User')">
                    <span style="margin-right: 8px;">🗑️</span> Remove
                </button>
            `;

            convItem.style.position = 'relative';
            convItem.appendChild(menu);
        }

        // Add these two helper functions
        async function toggleMute(event, userId, currentMutedState) {
            event.stopPropagation();
            const action = currentMutedState ? 'unmute' : 'mute';
            try {
                const response = await fetch(`/api/conversations/${action}/${userId}`, { method: 'POST' });
                if (response.ok) {
                    loadConversations(); // Refresh UI to reflect changes
                }
            } catch (e) {
                console.error(`Failed to ${action} conversation:`, e);
            }
        }

        function markAsUnreadLocally(event, userId) {
            event.stopPropagation();
            const item = document.getElementById(`conv-${userId}`) || document.getElementById(`pin-${userId}`);
            if (item) {
                item.classList.add('has-unread');
                // Ensure the menu closes
                document.querySelectorAll('.more-menu').forEach(menu => menu.remove());
            }
            // Trigger backend call
            fetch(`/api/conversations/unread/${userId}`, { method: 'POST' });
        }


        function showUserInfo(event, userId, fullName, email, department, username, status) {
            if (event) event.stopPropagation();
            document.getElementById('info-avatar').textContent = fullName.charAt(0).toUpperCase();
            document.getElementById('info-name').textContent = fullName;
            document.getElementById('info-email').textContent = email || 'N/A';
            document.getElementById('info-department').textContent = department || 'N/A';
            document.getElementById('info-status').textContent = (STATUS_MAP[status] || STATUS_MAP['AVAILABLE']).text;
            document.getElementById('info-username').textContent = username || 'N/A';
            showModal('user-info-modal');
        }

        async function removeConversation(event, userId, userName) {
            if (event) event.stopPropagation();
            if (!confirm(`Remove conversation with ${userName}?`)) return;
            const item = document.getElementById(`conv-${userId}`);
            if (item) item.style.display = 'none';
        }

        function filterConversations(query) {
            document.querySelectorAll('.conversation-item').forEach(item => {
                const name = item.querySelector('.conversation-name').textContent.toLowerCase();
                item.style.display = name.includes(query.toLowerCase()) ? 'flex' : 'none';
            });
        }

        async function startDirectChat(userId, fullName, department, email, username, status) {
            try {
                const response = await fetchJson(`/api/conversations?recipientId=${userId}`, { method: 'POST' });
                currentRecipient = { id: userId, fullName, department, email, username, status: status || 'AVAILABLE' };
                loadConversation(response.conversationId, currentRecipient);
            } catch (error) { console.error('Error starting conversation:', error); }
        }

        async function loadConversation(conversationId, recipient) {
            currentId = conversationId;
            currentType = 'direct';
            currentRecipient = recipient;
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('chat-window').classList.remove('hidden');
            updateChatHeader(recipient);
            const messages = await fetchJson(`/api/conversations/${conversationId}/messages`);
            allMessages = messages || [];
            renderMessages(allMessages);
            subscribeToConversation(conversationId);
            document.querySelectorAll('.conversation-item, .pin-item').forEach(el => el.classList.remove('active'));
            const activeConv = document.getElementById(`conv-${recipient.id}`) || document.getElementById(`pin-${recipient.id}`);
            if (activeConv) activeConv.classList.add('active');
        }

        function updateChatHeader(recipient) {
            document.getElementById('chat-avatar-initial').textContent = recipient.fullName.charAt(0).toUpperCase();
            document.getElementById('chat-header-name').textContent = recipient.fullName;
            updateChatHeaderStatus(recipient.status || 'AVAILABLE');
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            if (!messages?.length) return;
            let lastDate = null;
            messages.forEach(msg => {
                const msgDate = new Date(msg.createdAt).toDateString();
                if (msgDate !== lastDate) {
                    container.appendChild(createDateSeparator(msg.createdAt));
                    lastDate = msgDate;
                }
                container.appendChild(createMessageElementWithStatus(msg, String(msg.senderId) === String(myId), true));
            });
            container.scrollTop = container.scrollHeight;
        }

        function createDateSeparator(timestamp) {
            const div = document.createElement('div');
            div.className = 'date-separator';
            div.innerHTML = `<div class="date-separator-line"></div><div class="date-separator-text">${new Date(timestamp).toLocaleDateString()}</div><div class="date-separator-line"></div>`;
            return div;
        }

        function createMessageElementWithStatus(msg, isSent, showSender) {
            const div = document.createElement('div');
            div.className = `message-group ${isSent ? 'sent' : 'received'}`;
            if (msg.id) div.setAttribute('data-message-id', msg.id);
            let html = isSent ? '' : `<div class="message-sender"><div class="message-sender-avatar">${msg.senderName.charAt(0)}</div><div class="message-sender-name">${msg.senderName}</div></div>`;
            html += `<div class="message-bubble">${msg.content}</div>`;
            html += `<div class="message-time">${new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ${isSent ? renderMessageStatus(msg, true) : ''}</div>`;
            div.innerHTML = html;
            return div;
        }

        function subscribeToConversation(conversationId) {
            subscriptions.forEach(s => s.unsubscribe());
            subscriptions = [stompClient.subscribe(`/topic/conversation.${conversationId}`, (m) => displayNewMessage(JSON.parse(m.body)))];
        }

        function displayNewMessage(msg) {
            if (allMessages.find(m => m.id === msg.id)) return;
            allMessages.push(msg);
            const container = document.getElementById('messages-container');
            container.appendChild(createMessageElementWithStatus(msg, String(msg.senderId) === String(myId), true));
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content || !currentId) return;
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                chatType: 'conversation', chatId: currentId, content: content
            }));
            input.value = '';
        }

        function showModal(id) { document.getElementById(id).classList.add('active'); if (id === 'new-direct-modal') loadUsersForModal(); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }

        async function loadUsersForModal() {
            const users = await fetchJson('/api/users');
            document.getElementById('users-list-modal').innerHTML = users.map(u => `
                <div class="user-select-item" style="background: var(--bg-light); padding: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 4px 0; border-radius: 8px;" 
                     onclick="startDirectChat('${u.id}', '${u.fullName.replace(/'/g, "\\'")}', '${u.department || ''}', '${u.email || ''}', '${u.username || ''}', '${u.status || 'AVAILABLE'}'); closeModals();">
                    <div class="notification-avatar">${u.fullName.charAt(0)}</div>
                    <div><strong>${u.fullName}</strong><div style="font-size: 11px;">${u.department || 'N/A'}</div></div>
                </div>`).join('');
        }

        async function fetchJson(url, options = {}) {
            const response = await fetch(url, options);
            if (response.redirected && response.url.includes('/login')) { window.location.reload(); return; }
            return response.ok ? response.json() : null;
        }

        function closeChat() { document.getElementById('welcome-screen').classList.remove('hidden'); document.getElementById('chat-window').classList.add('hidden'); currentId = null; }
        function showChatInfo() { if (currentRecipient) showUserInfo(null, currentRecipient.id, currentRecipient.fullName, currentRecipient.email, currentRecipient.department, currentRecipient.username, currentRecipient.status); }
        window.onclick = (e) => { if (e.target.classList.contains('modal')) closeModals(); };
        document.getElementById('message-input').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    </script>
</body>

</html>